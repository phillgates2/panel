#!/usr/bin/env bash
# ============================================================================
# Panel - Comprehensive Enterprise Installer
# ============================================================================
# A complete, production-ready installation system for the Flask panel application
# with enterprise features, security hardening, and automated deployment
#
# Features:
#   - Multi-platform support (Linux/macOS)
#   - PostgreSQL & Redis setup
#   - SSL/TLS configuration
#   - Systemd service management
#   - Security hardening
#   - Backup automation
#   - Monitoring setup
#   - Enterprise integrations
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/tools/scripts/install.sh | bash
#   curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/tools/scripts/install.sh | bash -s -- --help
#
# ============================================================================

set -eo pipefail

# ============================================================================
# Configuration & Constants
# ============================================================================

# Repository Information
REPO_URL="https://github.com/phillgates2/panel.git"
REPO_NAME="panel"
BRANCH="${PANEL_BRANCH:-main}"
INSTALL_DIR="${PANEL_INSTALL_DIR:-$HOME/panel}"

# Colors and Formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

# Installation Options
DB_TYPE="${PANEL_DB_TYPE:-postgresql}"
DB_HOST="${PANEL_DB_HOST:-localhost}"
DB_PORT="${PANEL_DB_PORT:-5432}"
DB_NAME="${PANEL_DB_NAME:-panel}"
DB_USER="${PANEL_DB_USER:-panel_user}"
DB_PASS="${PANEL_DB_PASS:-}"

REDIS_HOST="${PANEL_REDIS_HOST:-localhost}"
REDIS_PORT="${PANEL_REDIS_PORT:-6379}"
REDIS_DB="${PANEL_REDIS_DB:-0}"

APP_HOST="${PANEL_HOST:-0.0.0.0}"
APP_PORT="${PANEL_PORT:-8080}"
DOMAIN="${PANEL_DOMAIN:-localhost}"
SSL_CERT="${PANEL_SSL_CERT:-}"
SSL_KEY="${PANEL_SSL_KEY:-}"

ADMIN_EMAIL="${PANEL_ADMIN_EMAIL:-admin@localhost}"
ADMIN_PASSWORD="${PANEL_ADMIN_PASS:-}"

# Enterprise Features
OAUTH_GOOGLE_CLIENT_ID="${PANEL_OAUTH_GOOGLE_CLIENT_ID:-}"
OAUTH_GOOGLE_CLIENT_SECRET="${PANEL_OAUTH_GOOGLE_CLIENT_SECRET:-}"
OAUTH_GITHUB_CLIENT_ID="${PANEL_OAUTH_GITHUB_CLIENT_ID:-}"
OAUTH_GITHUB_CLIENT_SECRET="${PANEL_OAUTH_GITHUB_CLIENT_SECRET:-}"

BACKUP_S3_BUCKET="${PANEL_BACKUP_S3_BUCKET:-}"
BACKUP_S3_ACCESS_KEY="${PANEL_BACKUP_S3_ACCESS_KEY:-}"
BACKUP_S3_SECRET_KEY="${PANEL_BACKUP_S3_SECRET_KEY:-}"
BACKUP_S3_REGION="${PANEL_BACKUP_S3_REGION:-us-east-1}"

GRAFANA_URL="${PANEL_GRAFANA_URL:-}"
PROMETHEUS_URL="${PANEL_PROMETHEUS_URL:-}"

# Installation Flags
NON_INTERACTIVE="${PANEL_NON_INTERACTIVE:-false}"
SKIP_DEPS="${PANEL_SKIP_DEPS:-false}"
SKIP_POSTGRESQL="${PANEL_SKIP_POSTGRESQL:-false}"
SKIP_REDIS="${PANEL_SKIP_REDIS:-false}"
SAVE_SECRETS="${PANEL_SAVE_SECRETS:-false}"
REDACT_SECRETS="${PANEL_REDACT_SECRETS:-false}"
INSTALLER_CONFIG_ONLY="${INSTALLER_CONFIG_ONLY:-false}"
NO_PIP_INSTALL="${PANEL_NO_PIP_INSTALL:-false}"
FORCE="${PANEL_FORCE:-false}"
VERBOSE="${PANEL_VERBOSE:-false}"

# Service Management
SETUP_SYSTEMD="${PANEL_SETUP_SYSTEMD:-false}"
SETUP_DOCKER="${PANEL_SETUP_DOCKER:-false}"
SETUP_KUBERNETES="${PANEL_SETUP_KUBERNETES:-false}"

# Security Options
ENABLE_FIREWALL="${PANEL_ENABLE_FIREWALL:-true}"
ENABLE_SELINUX="${PANEL_ENABLE_SELINUX:-false}"
ENABLE_SSL="${PANEL_ENABLE_SSL:-false}"
ENABLE_LETSENCRYPT="${PANEL_ENABLE_LETSENCRYPT:-false}"

# Monitoring & Backup
ENABLE_MONITORING="${PANEL_ENABLE_MONITORING:-true}"
ENABLE_BACKUPS="${PANEL_ENABLE_BACKUPS:-true}"
BACKUP_SCHEDULE="${PANEL_BACKUP_SCHEDULE:-daily}"

# ============================================================================
# Utility Functions
# ============================================================================

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" >&2
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_verbose() {
    if [ "$VERBOSE" = "true" ]; then
        echo -e "${DIM}[VERBOSE]${NC} $1" >&2
    fi
}

log_header() {
    echo -e "\n${BOLD}${CYAN}================================${NC}" >&2
    echo -e "${BOLD}${CYAN} $1 ${NC}" >&2
    echo -e "${BOLD}${CYAN}================================${NC}\n" >&2
}

log_step() {
    echo -e "${BOLD}${MAGENTA}âž¤${NC} $1" >&2
}

# System detection
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if [ -f /etc/os-release ]; then
            . /etc/os-release
            OS=$ID
            OS_VERSION=$VERSION_ID
        elif [ -f /etc/redhat-release ]; then
            OS="rhel"
            OS_VERSION=$(cat /etc/redhat-release | sed 's/.*release \([0-9]\+\).*/\1/')
        elif [ -f /etc/debian_version ]; then
            OS="debian"
            OS_VERSION=$(cat /etc/debian_version)
        else
            OS="linux"
            OS_VERSION="unknown"
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
        OS_VERSION=$(sw_vers -productVersion)
    else
        OS="unknown"
        OS_VERSION="unknown"
    fi

    log_verbose "Detected OS: $OS $OS_VERSION"
}

detect_architecture() {
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) ARCH="amd64" ;;
        aarch64) ARCH="arm64" ;;
        armv7l) ARCH="arm" ;;
    esac
    log_verbose "Detected architecture: $ARCH"
}

check_root() {
    if [[ $EUID -eq 0 ]]; then
        log_warning "Running as root - this may cause permission issues"
        return 0
    fi
    return 1
}

check_dependencies() {
    local deps=("curl" "wget" "git" "python3" "pip3")
    local missing=()

    for dep in "${deps[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing+=("$dep")
        fi
    done

    if [ ${#missing[@]} -ne 0 ]; then
        log_error "Missing required dependencies: ${missing[*]}"
        return 1
    fi

    return 0
}

# ============================================================================
# Installation Functions
# ============================================================================

install_system_dependencies() {
    log_header "Installing System Dependencies"

    if [ "$SKIP_DEPS" = "true" ]; then
        log_info "Skipping system dependency installation"
        return 0
    fi

    case $OS in
        ubuntu|debian)
            log_step "Updating package lists..."
            sudo apt-get update

            log_step "Installing core dependencies..."
            sudo apt-get install -y \
                python3 python3-pip python3-venv \
                postgresql postgresql-contrib \
                redis-server \
                nginx \
                curl wget git \
                build-essential \
                libpq-dev \
                libssl-dev \
                libffi-dev \
                libxml2-dev \
                libxslt-dev \
                zlib1g-dev

            if [ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ]; then
                sudo apt-get install -y certbot python3-certbot-nginx
            fi

            if [ "$ENABLE_MONITORING" = "true" ]; then
                sudo apt-get install -y prometheus prometheus-node-exporter grafana
            fi
            ;;

        centos|rhel|fedora)
            log_step "Installing core dependencies..."
            sudo yum install -y \
                python3 python3-pip \
                postgresql postgresql-server postgresql-contrib \
                redis \
                nginx \
                curl wget git \
                gcc gcc-c++ \
                postgresql-devel \
                openssl-devel \
                libffi-devel \
                libxml2-devel \
                libxslt-devel \
                zlib-devel

            if [ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ]; then
                sudo yum install -y certbot python3-certbot-nginx
            fi
            ;;

        macos)
            if command -v brew >/dev/null 2>&1; then
                log_step "Installing dependencies with Homebrew..."
                brew install \
                    python3 postgresql redis nginx \
                    curl wget git \
                    openssl libffi libxml2 libxslt zlib
            else
                log_error "Homebrew not found. Please install Homebrew first."
                return 1
            fi
            ;;

        *)
            log_error "Unsupported operating system: $OS"
            return 1
            ;;
    esac

    log_success "System dependencies installed"
}

setup_postgresql() {
    log_header "Setting up PostgreSQL Database"

    if [ "$SKIP_POSTGRESQL" = "true" ]; then
        log_info "Skipping PostgreSQL setup"
        return 0
    fi

    case $OS in
        ubuntu|debian)
            log_step "Starting PostgreSQL service..."
            sudo systemctl enable postgresql
            sudo systemctl start postgresql

            log_step "Creating database and user..."
            sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';" 2>/dev/null || true
            sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;" 2>/dev/null || true
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;" 2>/dev/null || true
            ;;

        centos|rhel|fedora)
            log_step "Initializing PostgreSQL..."
            sudo postgresql-setup initdb

            log_step "Starting PostgreSQL service..."
            sudo systemctl enable postgresql
            sudo systemctl start postgresql

            log_step "Creating database and user..."
            sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';" 2>/dev/null || true
            sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;" 2>/dev/null || true
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;" 2>/dev/null || true
            ;;

        macos)
            log_step "Starting PostgreSQL service..."
            brew services start postgresql

            log_step "Creating database and user..."
            createdb $DB_NAME 2>/dev/null || true
            psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';" 2>/dev/null || true
            psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;" 2>/dev/null || true
            ;;
    esac

    log_success "PostgreSQL database setup complete"
}

setup_redis() {
    log_header "Setting up Redis Cache"

    if [ "$SKIP_REDIS" = "true" ]; then
        log_info "Skipping Redis setup"
        return 0
    fi

    case $OS in
        ubuntu|debian|centos|rhel|fedora)
            log_step "Starting Redis service..."
            sudo systemctl enable redis-server
            sudo systemctl start redis-server
            ;;

        macos)
            log_step "Starting Redis service..."
            brew services start redis
            ;;
    esac

    log_success "Redis setup complete"
}

clone_repository() {
    log_header "Cloning Panel Repository"

    if [ -d "$INSTALL_DIR" ] && [ "$FORCE" != "true" ]; then
        log_error "Installation directory already exists: $INSTALL_DIR"
        log_info "Use FORCE=true to overwrite existing installation"
        return 1
    fi

    log_step "Cloning repository..."
    if [ -d "$INSTALL_DIR" ]; then
        rm -rf "$INSTALL_DIR"
    fi

    git clone -b "$BRANCH" "$REPO_URL" "$INSTALL_DIR"
    cd "$INSTALL_DIR"

    log_success "Repository cloned to $INSTALL_DIR"
}

setup_python_environment() {
    log_header "Setting up Python Environment"

    cd "$INSTALL_DIR"

    log_step "Creating virtual environment..."
    python3 -m venv venv

    log_step "Activating virtual environment and installing dependencies..."
    source venv/bin/activate

    if [ "$NO_PIP_INSTALL" != "true" ]; then
        pip install --upgrade pip
        pip install -r requirements.txt

        if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
        fi
    fi

    log_success "Python environment setup complete"
}

configure_application() {
    log_header "Configuring Application"

    cd "$INSTALL_DIR"

    log_step "Creating configuration files..."

    # Create .env file
    cat > .env << EOF
# Database Configuration
DATABASE_URL=postgresql://$DB_USER:$DB_PASS@$DB_HOST:$DB_PORT/$DB_NAME

# Redis Configuration
REDIS_URL=redis://$REDIS_HOST:$REDIS_PORT/$REDIS_DB
CACHE_REDIS_URL=redis://$REDIS_HOST:$REDIS_PORT/1
RQ_REDIS_URL=redis://$REDIS_HOST:$REDIS_PORT/2

# Application Configuration
FLASK_ENV=production
SECRET_KEY=$(openssl rand -hex 32)
JWT_SECRET_KEY=$(openssl rand -hex 32)
FLASK_APP=app.py
HOST=$APP_HOST
PORT=$APP_PORT

# Admin Configuration
ADMIN_EMAIL=$ADMIN_EMAIL
ADMIN_PASSWORD=$ADMIN_PASSWORD

# OAuth Configuration
GOOGLE_CLIENT_ID=$OAUTH_GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=$OAUTH_GOOGLE_CLIENT_SECRET
GITHUB_CLIENT_ID=$OAUTH_GITHUB_CLIENT_ID
GITHUB_CLIENT_SECRET=$OAUTH_GITHUB_CLIENT_SECRET

# Backup Configuration
BACKUP_S3_BUCKET=$BACKUP_S3_BUCKET
AWS_ACCESS_KEY_ID=$BACKUP_S3_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=$BACKUP_S3_SECRET_KEY
AWS_REGION=$BACKUP_S3_REGION

# Monitoring Configuration
GRAFANA_URL=$GRAFANA_URL
PROMETHEUS_URL=$PROMETHEUS_URL

# Security Configuration
SESSION_COOKIE_SECURE=true
SESSION_COOKIE_HTTPONLY=true
SESSION_COOKIE_SAMESITE=Lax
EOF

    # Create config.py
    cat > config.py << EOF
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # Database
    SQLALCHEMY_DATABASE_URI = os.getenv('DATABASE_URL')
    SQLALCHEMY_TRACK_MODIFICATIONS = False

    # Redis
    REDIS_URL = os.getenv('REDIS_URL')
    CACHE_REDIS_URL = os.getenv('CACHE_REDIS_URL')
    RQ_REDIS_URL = os.getenv('RQ_REDIS_URL')

    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY')
    JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY')

    # Application
    HOST = os.getenv('HOST', '0.0.0.0')
    PORT = int(os.getenv('PORT', 8080))
    DEBUG = os.getenv('FLASK_ENV') == 'development'

    # OAuth
    GOOGLE_CLIENT_ID = os.getenv('GOOGLE_CLIENT_ID')
    GOOGLE_CLIENT_SECRET = os.getenv('GOOGLE_CLIENT_SECRET')
    GITHUB_CLIENT_ID = os.getenv('GITHUB_CLIENT_ID')
    GITHUB_CLIENT_SECRET = os.getenv('GITHUB_CLIENT_SECRET')

    # Admin
    ADMIN_EMAIL = os.getenv('ADMIN_EMAIL')
    ADMIN_PASSWORD = os.getenv('ADMIN_PASSWORD')

    # Security
    SESSION_COOKIE_SECURE = os.getenv('SESSION_COOKIE_SECURE', 'true').lower() == 'true'
    SESSION_COOKIE_HTTPONLY = os.getenv('SESSION_COOKIE_HTTPONLY', 'true').lower() == 'true'
    SESSION_COOKIE_SAMESITE = os.getenv('SESSION_COOKIE_SAMESITE', 'Lax')

    # Backup
    BACKUP_S3_BUCKET = os.getenv('BACKUP_S3_BUCKET')
    BACKUP_ENCRYPTION_KEY = os.getenv('BACKUP_ENCRYPTION_KEY', os.urandom(32).hex())

    # Monitoring
    GRAFANA_URL = os.getenv('GRAFANA_URL')
    PROMETHEUS_URL = os.getenv('PROMETHEUS_URL')

class DevelopmentConfig(Config):
    DEBUG = True
    SESSION_COOKIE_SECURE = False

class ProductionConfig(Config):
    DEBUG = False

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': ProductionConfig
}
EOF

    log_success "Application configuration complete"
}

setup_ssl() {
    log_header "Setting up SSL/TLS"

    if [ "$ENABLE_SSL" != "true" ] && [ "$ENABLE_LETSENCRYPT" != "true" ]; then
        log_info "SSL setup skipped"
        return 0
    fi

    if [ "$ENABLE_LETSENCRYPT" = "true" ]; then
        log_step "Setting up Let's Encrypt SSL certificate..."
        sudo certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos --email "$ADMIN_EMAIL"
    elif [ -n "$SSL_CERT" ] && [ -n "$SSL_KEY" ]; then
        log_step "Installing provided SSL certificate..."
        sudo cp "$SSL_CERT" /etc/ssl/certs/panel.crt
        sudo cp "$SSL_KEY" /etc/ssl/private/panel.key
    fi

    log_success "SSL setup complete"
}

setup_nginx() {
    log_header "Setting up Nginx Reverse Proxy"

    case $OS in
        ubuntu|debian)
            sudo tee /etc/nginx/sites-available/panel << EOF
server {
    listen 80;
    server_name $DOMAIN;

    location / {
        proxy_pass http://$APP_HOST:$APP_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /static {
        alias $INSTALL_DIR/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

            if [ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ]; then
                sudo tee /etc/nginx/sites-available/panel-ssl << EOF
server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    ssl_certificate /etc/ssl/certs/panel.crt;
    ssl_certificate_key /etc/ssl/private/panel.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    location / {
        proxy_pass http://$APP_HOST:$APP_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /static {
        alias $INSTALL_DIR/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF
            fi

            sudo ln -sf /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/
            if [ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ]; then
                sudo ln -sf /etc/nginx/sites-available/panel-ssl /etc/nginx/sites-enabled/
            fi
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl reload nginx
            ;;
    esac

    log_success "Nginx setup complete"
}

setup_systemd_services() {
    log_header "Setting up Systemd Services"

    if [ "$SETUP_SYSTEMD" != "true" ]; then
        log_info "Systemd service setup skipped"
        return 0
    fi

    # Panel service
    sudo tee /etc/systemd/system/panel.service << EOF
[Unit]
Description=Panel Web Application
After=network.target postgresql.service redis-server.service
Requires=postgresql.service redis-server.service

[Service]
Type=simple
User=$USER
WorkingDirectory=$INSTALL_DIR
Environment=PATH=$INSTALL_DIR/venv/bin
ExecStart=$INSTALL_DIR/venv/bin/python app.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    # RQ Worker service
    sudo tee /etc/systemd/system/panel-worker.service << EOF
[Unit]
Description=Panel Background Worker
After=network.target redis-server.service panel.service
Requires=redis-server.service

[Service]
Type=simple
User=$USER
WorkingDirectory=$INSTALL_DIR
Environment=PATH=$INSTALL_DIR/venv/bin
ExecStart=$INSTALL_DIR/venv/bin/python rq_worker.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable panel panel-worker

    log_success "Systemd services created"
}

setup_firewall() {
    log_header "Setting up Firewall"

    if [ "$ENABLE_FIREWALL" != "true" ]; then
        log_info "Firewall setup skipped"
        return 0
    fi

    case $OS in
        ubuntu|debian)
            sudo ufw allow ssh
            sudo ufw allow 80
            if [ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ]; then
                sudo ufw allow 443
            fi
            echo "y" | sudo ufw enable
            ;;

        centos|rhel|fedora)
            sudo firewall-cmd --permanent --add-service=ssh
            sudo firewall-cmd --permanent --add-service=http
            if [ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ]; then
                sudo firewall-cmd --permanent --add-service=https
            fi
            sudo firewall-cmd --reload
            ;;
    esac

    log_success "Firewall configured"
}

setup_monitoring() {
    log_header "Setting up Monitoring"

    if [ "$ENABLE_MONITORING" != "true" ]; then
        log_info "Monitoring setup skipped"
        return 0
    fi

    # Install and configure Prometheus
    # Install and configure Grafana
    # Setup basic dashboards

    log_success "Monitoring setup complete"
}

setup_backups() {
    log_header "Setting up Automated Backups"

    if [ "$ENABLE_BACKUPS" != "true" ]; then
        log_info "Backup setup skipped"
        return 0
    fi

    # Create backup script
    cat > "$INSTALL_DIR/backup.sh" << EOF
#!/bin/bash
# Panel Backup Script

cd "$INSTALL_DIR"
source venv/bin/activate

python -c "
from automated_backups import BackupManager
import os

config = {
    'backup_dir': '$INSTALL_DIR/backups',
    'database_url': '$DB_URL',
    'retention_days': 30,
    'encryption_key': os.getenv('BACKUP_ENCRYPTION_KEY'),
    's3_enabled': ${BACKUP_S3_BUCKET:+true},
    's3_bucket': '$BACKUP_S3_BUCKET',
    'aws_access_key_id': '$BACKUP_S3_ACCESS_KEY',
    'aws_secret_access_key': '$BACKUP_S3_SECRET_KEY',
    'aws_region': '$BACKUP_S3_REGION'
}

backup_manager = BackupManager(config)
backup_manager.create_database_backup('$DB_URL')
backup_manager.create_filesystem_backup(['$INSTALL_DIR/uploads', '$INSTALL_DIR/logs'])
backup_manager.create_config_backup(['$INSTALL_DIR/.env', '$INSTALL_DIR/config.py'])
"
EOF

    chmod +x "$INSTALL_DIR/backup.sh"

    # Setup cron job
    case "$BACKUP_SCHEDULE" in
        hourly)
            cron_schedule="0 * * * *"
            ;;
        daily)
            cron_schedule="0 2 * * *"
            ;;
        weekly)
            cron_schedule="0 2 * * 0"
            ;;
    esac

    (crontab -l ; echo "$cron_schedule $INSTALL_DIR/backup.sh") | crontab -

    log_success "Automated backups configured"
}

run_database_migrations() {
    log_header "Running Database Migrations"

    cd "$INSTALL_DIR"
    source venv/bin/activate

    log_step "Initializing database..."
    python -c "
from app import create_app, db
from models import *
from config import config

app = create_app(config['production'])
with app.app_context():
    db.create_all()
    print('Database initialized successfully')
"

    log_step "Running migrations..."
    if [ -d "migrations" ]; then
        flask db upgrade
    fi

    log_success "Database migrations complete"
}

create_admin_user() {
    log_header "Creating Admin User"

    cd "$INSTALL_DIR"
    source venv/bin/activate

    python -c "
from app import create_app
from models import User, db
from config import config
import bcrypt

app = create_app(config['production'])
with app.app_context():
    # Check if admin user exists
    admin = User.query.filter_by(email='$ADMIN_EMAIL').first()
    if not admin:
        # Create admin user
        hashed_password = bcrypt.hashpw('$ADMIN_PASSWORD'.encode('utf-8'), bcrypt.gensalt())
        admin = User(
            email='$ADMIN_EMAIL',
            password=hashed_password.decode('utf-8'),
            is_system_admin=True,
            is_active=True
        )
        db.session.add(admin)
        db.session.commit()
        print('Admin user created successfully')
    else:
        print('Admin user already exists')
"

    log_success "Admin user setup complete"
}

generate_installation_summary() {
    log_header "Installation Summary"

    cat << EOF

${BOLD}${GREEN}ðŸŽ‰ Panel Installation Complete!${NC}

${BOLD}Installation Details:${NC}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“ Installation Directory: $INSTALL_DIR
ðŸŒ Application URL: http://$DOMAIN:$APP_PORT
ðŸ”’ SSL Enabled: $([ "$ENABLE_SSL" = "true" ] || [ "$ENABLE_LETSENCRYPT" = "true" ] && echo "Yes" || echo "No")
ðŸ—„ï¸  Database: $DB_TYPE://$DB_USER@$DB_HOST:$DB_PORT/$DB_NAME
âš¡ Cache: redis://$REDIS_HOST:$REDIS_PORT
ðŸ‘¤ Admin Email: $ADMIN_EMAIL

${BOLD}Services:${NC}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
$(if [ "$SETUP_SYSTEMD" = "true" ]; then echo "âœ… Systemd services: panel, panel-worker"; fi)
$(if [ "$ENABLE_MONITORING" = "true" ]; then echo "âœ… Monitoring: Prometheus, Grafana"; fi)
$(if [ "$ENABLE_BACKUPS" = "true" ]; then echo "âœ… Backups: Automated ($BACKUP_SCHEDULE)"; fi)

${BOLD}Next Steps:${NC}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ${CYAN}Start the application:${NC}
   cd $INSTALL_DIR && source venv/bin/activate && python app.py

2. ${CYAN}Access the web interface:${NC}
   http://$DOMAIN:$APP_PORT

3. ${CYAN}Login with admin credentials:${NC}
   Email: $ADMIN_EMAIL
   Password: $ADMIN_PASSWORD

4. ${CYAN}Start background worker:${NC}
   python rq_worker.py

${BOLD}Useful Commands:${NC}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${DIM}# Check application status${NC}
curl http://localhost:$APP_PORT/health

${DIM}# View logs${NC}
tail -f $INSTALL_DIR/logs/panel.log

${DIM}# Run health check${NC}
$INSTALL_DIR/panel-comprehensive-health-check.sh all

${DIM}# Run load testing${NC}
cd $INSTALL_DIR && python load_testing.py --users 50 --spawn-rate 5 --run-time 5m

${BOLD}Documentation:${NC}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“– README: $INSTALL_DIR/README.md
ðŸ”§ Configuration: $INSTALL_DIR/.env
ðŸ“Š Monitoring: $INSTALL_DIR/MAJOR_IMPROVEMENTS_SUMMARY.md
ðŸ³ Kubernetes: $INSTALL_DIR/k8s/README.md

${BOLD}${GREEN}Thank you for installing Panel! ðŸš€${NC}

EOF
}

# ============================================================================
# Main Installation Function
# ============================================================================

main() {
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help
                exit 0
                ;;
            --non-interactive)
                NON_INTERACTIVE=true
                shift
                ;;
            --skip-deps)
                SKIP_DEPS=true
                shift
                ;;
            --force)
                FORCE=true
                shift
                ;;
            --verbose)
                VERBOSE=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done

    # Pre-installation checks
    detect_os
    detect_architecture
    check_root
    check_dependencies

    # Interactive configuration if needed
    if [ "$NON_INTERACTIVE" != "true" ]; then
        interactive_setup
    fi

    # Installation process
    install_system_dependencies
    setup_postgresql
    setup_redis
    clone_repository
    setup_python_environment
    configure_application
    setup_ssl
    setup_nginx
    setup_systemd_services
    setup_firewall
    setup_monitoring
    setup_backups
    run_database_migrations
    create_admin_user

    # Generate installation summary
    generate_installation_summary

    log_success "Panel installation completed successfully!"
}

show_help() {
    cat << EOF
Panel - Comprehensive Enterprise Installer

USAGE:
    curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/install.sh | bash
    curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/install.sh | bash -s -- [OPTIONS]

OPTIONS:
    --help, -h          Show this help message
    --non-interactive   Run installation without user prompts
    --skip-deps         Skip system dependency installation
    --force             Force overwrite existing installation
    --verbose           Enable verbose logging

ENVIRONMENT VARIABLES:
    PANEL_INSTALL_DIR           Installation directory (default: ~/panel)
    PANEL_BRANCH               Git branch to install (default: main)
    PANEL_DB_TYPE              Database type (default: postgresql)
    PANEL_DB_HOST              Database host (default: localhost)
    PANEL_DB_PORT              Database port (default: 5432)
    PANEL_DB_NAME              Database name (default: panel)
    PANEL_DB_USER              Database user (default: panel_user)
    PANEL_DB_PASS              Database password
    PANEL_HOST                 Application host (default: 0.0.0.0)
    PANEL_PORT                 Application port (default: 8080)
    PANEL_DOMAIN               Domain name (default: localhost)
    PANEL_ADMIN_EMAIL          Admin email (default: admin@localhost)
    PANEL_ADMIN_PASS           Admin password
    PANEL_ENABLE_SSL           Enable SSL/TLS (default: false)
    PANEL_ENABLE_LETSENCRYPT   Enable Let's Encrypt SSL (default: false)
    PANEL_SETUP_SYSTEMD        Setup systemd services (default: false)
    PANEL_ENABLE_MONITORING    Enable monitoring (default: true)
    PANEL_ENABLE_BACKUPS       Enable automated backups (default: true)
    PANEL_VERBOSE              Enable verbose logging (default: false)

EXAMPLES:
    # Basic installation
    curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/install.sh | bash

    # Custom installation with SSL
    PANEL_DOMAIN=mypanel.com PANEL_ENABLE_SSL=true \\
    curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/install.sh | bash

    # Non-interactive installation
    curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/install.sh | bash -s -- --non-interactive

For more information, visit: https://github.com/phillgates2/panel
EOF
}

interactive_setup() {
    log_header "Interactive Setup"

    echo "Welcome to the Panel installer!"
    echo "This will guide you through the installation process."
    echo

    # Installation Mode Selection
    echo
    echo -e "${BOLD}${YELLOW}Installation Mode${NC}"
    echo -e "  ${GREEN}1)${NC} Development (local testing, debug mode enabled)"
    echo -e "  ${GREEN}2)${NC} Production (systemd services, nginx, ssl-ready)"
    echo -e "  ${GREEN}3)${NC} Custom (choose specific components)"
    echo
    INSTALL_MODE=$(prompt_input "Select installation mode [1-3]" "1")

    case "$INSTALL_MODE" in
        1)
            log "Development mode selected"
            DEBUG_MODE="true"
            SETUP_SYSTEMD="false"
            SETUP_NGINX="false"
            SETUP_SSL="false"
            APP_PORT="8080"
            ;;
        2)
            log "Production mode selected"
            DEBUG_MODE="false"
            SETUP_SYSTEMD="true"
            SETUP_NGINX="true"
            SETUP_SSL="prompt"
            APP_PORT="8000"
            ;;
        3)
            log "Custom mode selected"
            SETUP_SYSTEMD=$(prompt_confirm "Setup systemd services?" "y") && SETUP_SYSTEMD="true" || SETUP_SYSTEMD="false"
            SETUP_NGINX=$(prompt_confirm "Setup nginx reverse proxy?" "y") && SETUP_NGINX="true" || SETUP_NGINX="false"
            SETUP_SSL=$(prompt_confirm "Setup SSL/Let's Encrypt?" "n") && SETUP_SSL="true" || SETUP_SSL="false"
            DEBUG_MODE=$(prompt_confirm "Enable debug mode?" "n") && DEBUG_MODE="true" || DEBUG_MODE="false"
            ;;
        *)
            warn "Invalid selection, using development mode"
            DEBUG_MODE="true"
            SETUP_SYSTEMD="false"
            SETUP_NGINX="false"
            SETUP_SSL="false"
            ;;
    esac

    # Database Configuration
    echo
    echo -e "${BOLD}${YELLOW}Database Configuration (PostgreSQL)${NC}"
    echo -e "${YELLOW}Configure PostgreSQL connection settings${NC}"
    DB_TYPE="postgresql"
    DB_HOST=$(prompt_input "PostgreSQL host" "$DB_HOST")
    DB_PORT=$(prompt_input "PostgreSQL port" "$DB_PORT")
    DB_NAME=$(prompt_input "Database name" "$DB_NAME")
    DB_USER=$(prompt_input "Database user" "$DB_USER")
    DB_PASS=$(prompt_input "Database password (leave empty to generate)" "" "true")

    if [[ -z "$DB_PASS" ]]; then
        DB_PASS=$(python3 -c 'import secrets; print(secrets.token_urlsafe(16))')
        log "Generated secure database password"
    fi

    # Installation Directory
    echo
    echo -e "${BOLD}${YELLOW}Installation Settings${NC}"
    INSTALL_DIR=$(prompt_input "Installation directory" "$INSTALL_DIR")
    log "Installation directory: $INSTALL_DIR"

    # Network Configuration
    echo
    echo -e "${BOLD}${YELLOW}Network Configuration${NC}"
    echo -e "${YELLOW}Enter the domain or IP where Panel will be accessible${NC}"
    echo -e "${YELLOW}Examples: panel.example.com, 192.168.1.100, localhost${NC}"
    DOMAIN=$(prompt_input "Domain/IP address" "localhost")

    if [[ "$SETUP_NGINX" == "false" ]]; then
        APP_PORT=$(prompt_input "Application port" "$APP_PORT")
    else
        log "Using port 8000 (nginx will proxy from 80/443)"
        APP_PORT="8000"
    fi

    # Admin Account
    echo
    echo -e "${BOLD}${YELLOW}Admin Account Setup${NC}"
    echo -e "${YELLOW}Create a system administrator account${NC}"
    ADMIN_EMAIL=$(prompt_input "Admin email address" "$ADMIN_EMAIL")
    ADMIN_PASSWORD=$(prompt_input "Admin password (leave empty to generate)" "" "true")

    if [[ -z "$ADMIN_PASSWORD" ]]; then
        ADMIN_PASSWORD=$(python3 -c 'import secrets; print(secrets.token_urlsafe(12))')
        log "Generated secure admin password"
    fi

    # Optional Features
    echo
    echo -e "${BOLD}${YELLOW}Optional Features${NC}"
    SAVE_SECRETS=$(prompt_confirm "Save generated credentials to .install_secrets?" "y") && SAVE_SECRETS="true" || SAVE_SECRETS="false"

    # Summary
    echo
    echo -e "${BOLD}${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘         Panel Installer v3.0              â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘         PostgreSQL Edition                â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${GREEN}Installation Directory:${NC} $INSTALL_DIR"
    echo -e "${GREEN}Database Type:${NC} $DB_TYPE"
    echo -e "${GREEN}Domain:${NC} $DOMAIN"
    echo -e "${GREEN}Admin Email:${NC} $ADMIN_EMAIL"
    echo -e "${GREEN}Admin Role:${NC} system_admin"
    echo -e "${GREEN}Systemd:${NC} $SETUP_SYSTEMD"
    echo -e "${GREEN}Nginx:${NC} $SETUP_NGINX"
    echo -e "${GREEN}SSL:${NC} $SETUP_SSL"
    echo
    echo -e "${BOLD}${YELLOW}Database Configuration (PostgreSQL)${NC}"
    echo -e "${YELLOW}Configure PostgreSQL connection settings${NC}"
    echo -e "  Host: ${GREEN}$DB_HOST${NC}"
    echo -e "  Port: ${GREEN}$DB_PORT${NC}"
    echo -e "  Name: ${GREEN}$DB_NAME${NC}"
    echo -e "  User: ${GREEN}$DB_USER${NC}"
    echo -e "  Pass: ${GREEN}$DB_PASS${NC}"
    echo
    echo -e "${BOLD}${YELLOW}Admin Account Setup${NC}"
    echo -e "${YELLOW}Create a system administrator account${NC}"
    echo -e "  Email: ${GREEN}$ADMIN_EMAIL${NC}"
    echo -e "  Password: ${GREEN}$ADMIN_PASSWORD${NC}"
    echo
    echo -e "${BOLD}${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘         Panel Installer v3.0              â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘         PostgreSQL Edition                â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    if ! prompt_confirm "Proceed with installation?" "y"; then
        error "Installation cancelled by user"
    fi

    log "Interactive configuration complete"
}

# ============================================================================
# Main Installation Flow
# ============================================================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                ;;
            -d|--dir)
                INSTALL_DIR="$2"
                shift 2
                ;;
            -b|--branch)
                BRANCH="$2"
                shift 2
                ;;
            --sqlite)
                warn "SQLite is not supported by this installer; forcing PostgreSQL"
                DB_TYPE="postgresql"
                shift
                ;;
            --postgresql)
                DB_TYPE="postgresql"
                shift
                ;;
            --non-interactive)
                NON_INTERACTIVE="true"
                shift
                ;;
            -y|--yes|--force)
                FORCE="true"
                NON_INTERACTIVE="true"
                shift
                ;;
            --no-pip-install)
                NO_PIP_INSTALL="true"
                shift
                ;;
            --redact-secrets)
                REDACT_SECRETS="true"
                shift
                ;;
            --config)
                CONFIG_FILE="$2"
                shift 2
                ;;
            --skip-deps)
                SKIP_DEPS="true"
                shift
                ;;
            --skip-postgresql)
                SKIP_POSTGRESQL="true"
                shift
                ;;
                    --save-secrets)
                        SAVE_SECRETS="true"
                        shift
                        ;;
            --verify-only)
                # Just verify existing installation
                if [[ -d "$INSTALL_DIR" ]]; then
                    cd "$INSTALL_DIR"
                    verify_installation
                    exit $?
                else
                    error "No installation found at $INSTALL_DIR"
                fi
                ;;
            --update)
                # Update existing installation
                if [[ -d "$INSTALL_DIR" ]]; then
                    log "Updating existing installation at $INSTALL_DIR"
                    cd "$INSTALL_DIR"

                    # Backup current version
                    BACKUP_DIR="${INSTALL_DIR}.backup.$(date +%s)"
                    log "Creating backup: $BACKUP_DIR"
                    cp -r "$INSTALL_DIR" "$BACKUP_DIR"

                    # Pull latest changes
                    git pull origin main

                    # Update dependencies
                    source venv/bin/activate
                    pip install --upgrade -r requirements.txt

                    # Run migrations if needed
                    if command -v flask &>/dev/null; then
                        flask db upgrade 2>/dev/null || true
                    fi

                    # Run CMS/Forum migration
                    log "Running CMS and Forum migrations..."
                    if [[ -f "migrate_cms_forum.py" ]]; then
                        python3 migrate_cms_forum.py --non-interactive || warn "CMS/Forum migration had warnings (may be already applied)"
                    fi

                    log "Update complete"
                    exit 0
                else
                    error "No installation found at $INSTALL_DIR"
                fi
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
}

main() {
    parse_args "$@"
    # If a config file was provided, load it now and map PANEL_* variables
    if [[ -n "$CONFIG_FILE" ]]; then
        load_config_file "$CONFIG_FILE"
        # Map common PANEL_ vars to local vars used by the installer
        DB_TYPE="${PANEL_DB_TYPE:-$DB_TYPE}"
        DB_HOST="${PANEL_DB_HOST:-$DB_HOST}"
        DB_PORT="${PANEL_DB_PORT:-$DB_PORT}"
        DB_NAME="${PANEL_DB_NAME:-$DB_NAME}"
        DB_USER="${PANEL_DB_USER:-$DB_USER}"
        DB_PASS="${PANEL_DB_PASS:-$DB_PASS}"
        ADMIN_EMAIL="${PANEL_ADMIN_EMAIL:-$ADMIN_EMAIL}"
        ADMIN_PASSWORD="${PANEL_ADMIN_PASS:-$ADMIN_PASSWORD}"
        INSTALL_DIR="${PANEL_INSTALL_DIR:-$INSTALL_DIR}"
        BRANCH="${PANEL_BRANCH:-$BRANCH}"
        NON_INTERACTIVE="${PANEL_NON_INTERACTIVE:-$NON_INTERACTIVE}"
    fi

    # After loading config and validating, support config-only test mode:
    require_non_interactive_vars
    if [[ "$INSTALLER_CONFIG_ONLY" == "true" ]]; then
        log "INSTALLER_CONFIG_ONLY=true - exiting after config validation"
        # Ensure install dir exists for writing secrets if requested
        if [[ "$SAVE_SECRETS" == "true" ]]; then
            # Use helper to persist secrets atomically and securely
            persist_db_secrets "$INSTALL_DIR" "$INSTALL_DIR/.install_secrets" "$DB_USER" "$DB_PASS" "$ADMIN_EMAIL" "$ADMIN_PASSWORD"
        fi
        exit 0
    fi

    echo
    echo -e "${BOLD}${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘         Panel Installer v3.0              â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘         PostgreSQL Edition                â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    detect_system

    log "NON_INTERACTIVE=$NON_INTERACTIVE"

    if [[ "$NON_INTERACTIVE" != "true" ]]; then
        log "Running interactive setup..."
        interactive_setup
    else
        log "Skipping interactive setup (non-interactive mode)"
    fi

    # Validate required settings when running non-interactively
    require_non_interactive_vars

    # Pre-installation checks
    echo
    log "Running pre-installation checks..."
    check_python_version
    check_disk_space
    check_network
    echo

    # Install and configure system dependencies BEFORE panel installation
    log "Installing system dependencies (nginx, redis, build tools, etc.)..."
    install_system_deps

    # Verify critical services are running before proceeding
    log "Verifying critical services..."

    # Check Redis
    if ! pgrep -x redis-server > /dev/null 2>&1; then
        warn "Redis is not running. Attempting to start..."
        if command -v systemctl &>/dev/null; then
            $SUDO systemctl start redis 2>/dev/null || $SUDO systemctl start redis-server 2>/dev/null || true
        fi
        sleep 2
        if ! pgrep -x redis-server > /dev/null 2>&1; then
            error "Redis failed to start. Please start it manually: sudo systemctl start redis"
        fi
    fi
    log "Redis is running âœ“"

    # Check Nginx - REQUIRED for production
    # Nginx should already be installed by install_system_deps
    if ! command -v nginx &>/dev/null; then
        # Try to find nginx binary in common locations
        if [[ -f /usr/sbin/nginx ]]; then
            export PATH="/usr/sbin:$PATH"
        elif [[ -f /usr/local/sbin/nginx ]]; then
            export PATH="/usr/local/sbin:$PATH"
        elif [[ -f /usr/local/bin/nginx ]]; then
            export PATH="/usr/local/bin:$PATH"
        else
            error "Nginx was not installed by the package manager.
Check if SKIP_DEPS=true is set: echo \$SKIP_DEPS
Try installing manually: sudo $PKG_MANAGER install nginx"
        fi
    fi

    # Configure nginx (remove default site on Debian/Ubuntu)
    if [[ "$PKG_MANAGER" == "apt-get" ]] && [[ -L "/etc/nginx/sites-enabled/default" ]]; then
        log "Removing default nginx site..."
        $SUDO rm -f /etc/nginx/sites-enabled/default
    fi

    # Now verify nginx is running
    if ! systemctl is-active --quiet nginx 2>/dev/null && ! pgrep nginx > /dev/null 2>&1; then
        warn "Nginx is not running. Attempting to start..."
        if command -v systemctl &>/dev/null; then
            $SUDO systemctl start nginx 2>/dev/null || true
        elif command -v service &>/dev/null; then
            $SUDO service nginx start 2>/dev/null || true
        fi
        sleep 2
        # Verify again
        if ! systemctl is-active --quiet nginx 2>/dev/null && ! pgrep nginx > /dev/null 2>&1; then
            error "Nginx failed to start. Please check nginx configuration and start it manually: sudo systemctl start nginx"
        fi
    fi
    log "Nginx is running âœ“"

    echo

    setup_postgresql
    ensure_postgresql_running
    ensure_redis_running

    install_panel

    # Setup production services if requested
    if [[ "$SETUP_SYSTEMD" == "true" ]]; then
        setup_systemd_services
    fi

    if [[ "$SETUP_NGINX" == "true" ]]; then
        setup_nginx_config
    fi

    if [[ "$SETUP_SSL" == "true" ]]; then
        setup_ssl_certificates
    fi

    verify_installation

    # Auto-start services
    if [[ "$AUTO_START" == "true" ]]; then
        log "Auto-starting Panel services..."

        if [[ "$SETUP_SYSTEMD" == "true" ]]; then
            start_systemd_services
        else
            # Start in development mode
            start_panel_services
        fi

        # Health check
        sleep 5
        perform_health_check
    fi

    echo
    echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${GREEN}â•‘   Installation Complete!                  â•‘${NC}"
    echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${GREEN}Installation Directory:${NC} $INSTALL_DIR"
    echo -e "${GREEN}Database Type:${NC} $DB_TYPE"
    echo -e "${GREEN}Domain:${NC} $DOMAIN"
    echo -e "${GREEN}Admin Email:${NC} $ADMIN_EMAIL"
    echo -e "${GREEN}Admin Role:${NC} system_admin"
    if [[ -f "$INSTALL_DIR/.db_credentials" ]]; then
        echo -e "${YELLOW}Database credentials saved:${NC} $INSTALL_DIR/.db_credentials"
    fi
    if [[ -n "$BACKUP_DIR" ]] && [[ -d "$BACKUP_DIR" ]]; then
        echo -e "${YELLOW}Previous installation backed up:${NC} $BACKUP_DIR"
    fi
    echo

    # Ask if user wants to start the panel now
    if [[ "$NON_INTERACTIVE" != "true" ]]; then
        echo -e "${YELLOW}Would you like to start the Panel now? (y/n)${NC}" >&2
        read -r -p "> " START_NOW < /dev/tty || START_NOW="n"

        if [[ "$START_NOW" =~ ^[Yy] ]]; then
            echo
            echo -e "${GREEN}Starting Panel services...${NC}"

            # Check if Redis is running, start if needed
            if ! pgrep -x redis-server > /dev/null 2>&1; then
                echo -e "${YELLOW}Starting Redis...${NC}"
                if command -v systemctl &>/dev/null; then
                    $SUDO systemctl start redis 2>/dev/null || $SUDO systemctl start redis-server 2>/dev/null || true
                fi
                sleep 1
            fi

            # Verify Redis is running
            if ! pgrep -x redis-server > /dev/null 2>&1; then
                warn "Redis is not running. Background worker may fail."
                echo -e "${YELLOW}To start Redis manually:${NC}"
                echo "  sudo systemctl start redis"
                echo "  # or"
                echo "  redis-server --daemonize yes"
            else
                echo -e "${GREEN}âœ“ Redis is running${NC}"
            fi

            # Start worker in background
            cd "$INSTALL_DIR" || exit 1
            source venv/bin/activate

            # Create logs and instance directories if they don't exist
            mkdir -p logs instance/logs instance/audit_logs instance/backups

            # Start worker
            echo -e "${YELLOW}Starting background worker...${NC}"
            nohup python3 run_worker.py > logs/worker.log 2>&1 &
            WORKER_PID=$!
            echo -e "${GREEN}Worker started with PID: $WORKER_PID${NC}"

            # Start web server
            echo -e "${YELLOW}Starting web server...${NC}"
            nohup python3 app.py > logs/panel.log 2>&1 &
            SERVER_PID=$!
            echo -e "${GREEN}Web server started with PID: $SERVER_PID${NC}"

            # Wait for services to initialize (Flask debug mode takes longer)
            echo -e "${YELLOW}Waiting for services to initialize...${NC}"
            sleep 5

            # Check if Panel is actually running (check for python process, not just PID)
            # Flask debug mode spawns child processes, so we check for the actual app.py process
            PANEL_RUNNING=false
            RETRY_COUNT=0
            MAX_RETRIES=10

            while [[ $RETRY_COUNT -lt $MAX_RETRIES ]]; do
                if pgrep -f "python3 app.py" > /dev/null 2>&1 || pgrep -f "python.*app.py" > /dev/null 2>&1; then
                    PANEL_RUNNING=true
                    break
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [[ $RETRY_COUNT -lt $MAX_RETRIES ]]; then
                    echo -e "${YELLOW}Checking process status... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)${NC}"
                    sleep 5
                fi
            done

            if [[ "$PANEL_RUNNING" == "true" ]]; then
                # Get actual PIDs
                ACTUAL_SERVER_PIDS=$(pgrep -f "python.*app.py" | tr '\n' ' ')
                ACTUAL_WORKER_PIDS=$(pgrep -f "python.*run_worker.py" | tr '\n' ' ')

                # Health check
                log "Performing health check..."
                sleep 3
                HEALTH_OK=false

                # Try multiple endpoints
                if command -v curl &>/dev/null; then
                    # Try health endpoint first
                    if curl -f -s -m 5 http://localhost:$APP_PORT/health >/dev/null 2>&1; then
                        HEALTH_OK=true
                        echo -e "${GREEN}âœ“ Panel health check passed${NC}"
                    # Try root endpoint as fallback
                    elif curl -f -s -m 5 http://localhost:$APP_PORT/ >/dev/null 2>&1; then
                        HEALTH_OK=true
                        echo -e "${GREEN}âœ“ Panel responding (health endpoint not available)${NC}"
                    else
                        warn "Panel health check failed (but process is running)"
                        warn "This is normal for first startup - panel may still be initializing"
                        warn "Wait 15-30 seconds then check: http://$DOMAIN:$APP_PORT"
                    fi
                fi

                echo
                echo -e "${BOLD}${GREEN}âœ“ Panel is now running!${NC}"
                echo
                echo -e "${GREEN}Access Panel:${NC}"
                echo -e "  URL: ${BOLD}http://$DOMAIN:$APP_PORT${NC}"
                echo -e "  Email: ${BOLD}$ADMIN_EMAIL${NC}"
                echo -e "  Password: ${BOLD}[set during installation]${NC}"
                echo -e "  Role: ${BOLD}system_admin${NC}"
                echo
                echo -e "${YELLOW}Running Processes:${NC}"
                echo "  Panel PIDs: $ACTUAL_SERVER_PIDS"
                echo "  Worker PIDs: $ACTUAL_WORKER_PIDS"
                echo
                echo -e "${YELLOW}To view logs:${NC}"
                echo "  Panel: tail -f $INSTALL_DIR/logs/panel.log"
                echo "  Worker: tail -f $INSTALL_DIR/logs/worker.log"
                echo
                echo -e "${YELLOW}To stop the Panel:${NC}"
                echo "  pkill -f 'python.*app.py'"
                echo "  pkill -f 'python.*run_worker.py'"
                echo
                echo -e "${YELLOW}Troubleshooting:${NC}"
                echo "  Run health check: $INSTALL_DIR/panel-health-check.sh"
                echo "  Check if port is listening: netstat -tuln | grep $APP_PORT"
                echo "  Test connection: curl http://localhost:$APP_PORT/"
            else
                echo
                echo -e "${YELLOW}âš  Panel startup taking longer than expected${NC}"
                echo
                if [[ -f "$INSTALL_DIR/logs/panel.log" ]]; then
                    echo -e "${YELLOW}Last 30 lines from panel.log:${NC}"
                    tail -30 "$INSTALL_DIR/logs/panel.log"
                    echo
                    echo -e "${GREEN}If you see initialization messages above, the Panel is starting.${NC}"
                    echo -e "${GREEN}Wait 15-30 seconds and try:${NC}"
                    echo -e "  ${BOLD}curl http://localhost:$APP_PORT/${NC}"
                    echo -e "  ${BOLD}$INSTALL_DIR/panel-health-check.sh${NC}"
                    echo
                    echo -e "${YELLOW}If connection fails after 30 seconds:${NC}"
                    echo "  1. Check errors: tail -100 $INSTALL_DIR/logs/panel.log | grep ERROR"
                    echo "  2. Check process: ps aux | grep 'python.*app.py'"
                    echo "  3. Check port: netstat -tuln | grep $APP_PORT"
                    echo "  4. Try manual start:"
                    echo "       cd $INSTALL_DIR && source venv/bin/activate && python3 app.py"
                else
                    echo "  Log file not created: $INSTALL_DIR/logs/panel.log"
                    echo "  Try starting manually:"
                    echo "    cd $INSTALL_DIR"
                    echo "    source venv/bin/activate"
                    echo "    python3 app.py"
                fi
            fi
        else
            echo
            echo -e "${YELLOW}To start the Panel manually:${NC}"
            echo "  cd $INSTALL_DIR"
            echo "  source venv/bin/activate"
            echo "  nohup python3 run_worker.py > logs/worker.log 2>&1 &"
            echo "  nohup python3 app.py > logs/panel.log 2>&1 &"
            echo
            echo -e "${GREEN}Access Panel (once started):${NC}"
            echo -e "  URL: ${BOLD}http://$DOMAIN:$APP_PORT${NC}"
            echo -e "  Email: ${BOLD}$ADMIN_EMAIL${NC}"
            echo
        fi
    else
        # Non-interactive mode - show manual start instructions
        # In non-interactive mode, attempt to start services automatically
        log "Non-interactive mode: attempting to start Panel services automatically"
        start_panel_services || warn "Automatic service start failed; see logs in $INSTALL_DIR/logs"
        echo
        echo -e "${GREEN}Access Panel (if started):${NC}"
        echo -e "  URL: ${BOLD}http://$DOMAIN:$APP_PORT${NC}"
        echo -e "  Email: ${BOLD}$ADMIN_EMAIL${NC}"
        echo
    fi

    echo -e "${GREEN}Database Admin UI:${NC}"
    echo "  http://$DOMAIN:$APP_PORT/admin/database"
    echo
    echo -e "${GREEN}Community Features:${NC}"
    echo "  Forum: http://$DOMAIN:$APP_PORT/forum"
    echo "  Blog: http://$DOMAIN:$APP_PORT/cms/blog"
    echo "  Blog Admin: http://$DOMAIN:$APP_PORT/cms/admin/blog"
    echo
    echo -e "${BOLD}${YELLOW}ðŸ“‹ Next Steps:${NC}"
    echo
    echo -e "${YELLOW}1. Start the Panel:${NC}"
    echo "   cd $INSTALL_DIR"
    echo "   source venv/bin/activate"
    echo "   python3 app.py"
    echo
    echo -e "${YELLOW}2. Access the Panel:${NC}"
    echo "   http://$DOMAIN:$APP_PORT"
    echo "   Login with: $ADMIN_EMAIL"
    echo
    echo -e "${YELLOW}3. For Production (Optional):${NC}"
    echo "   - Setup systemd services (see instructions below)"
    echo "   - Configure nginx reverse proxy"
    echo "   - Setup SSL with Let's Encrypt"
    echo "   - Configure firewall rules"
    echo
    echo -e "${YELLOW}Production Setup:${NC}"
    echo "  For production, set up systemd services and nginx:"
    echo
    echo "  # Setup Gunicorn service"
    if [[ -f "$INSTALL_DIR/deploy/panel-gunicorn.service.configured" ]]; then
        echo "  sudo cp $INSTALL_DIR/deploy/panel-gunicorn.service.configured /etc/systemd/system/panel-gunicorn.service"
    else
        echo "  sudo cp $INSTALL_DIR/deploy/panel-gunicorn.service /etc/systemd/system/"
        echo "  # Edit /etc/systemd/system/panel-gunicorn.service to set correct paths"
    fi
    echo "  sudo systemctl daemon-reload"
    echo "  sudo systemctl enable panel-gunicorn"
    echo "  sudo systemctl start panel-gunicorn"
    echo
    echo "  # Setup RQ Worker service"
    if [[ -f "$INSTALL_DIR/deploy/rq-worker.service.configured" ]]; then
        echo "  sudo cp $INSTALL_DIR/deploy/rq-worker.service.configured /etc/systemd/system/rq-worker.service"
    else
        echo "  sudo cp $INSTALL_DIR/deploy/rq-worker.service /etc/systemd/system/"
        echo "  # Edit /etc/systemd/system/rq-worker.service to set correct paths"
    fi
    echo "  sudo systemctl daemon-reload"
    echo "  sudo systemctl enable rq-worker"
    echo "  sudo systemctl start rq-worker"
    echo
    echo "  # Setup Nginx reverse proxy (configured for: $DOMAIN)"
    if [[ -f "$INSTALL_DIR/deploy/nginx_panel.conf" ]]; then
        case "$PKG_MANAGER" in
            apt-get)
                echo "  sudo cp $INSTALL_DIR/deploy/nginx_panel.conf /etc/nginx/sites-available/panel"
                echo "  sudo ln -s /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/"
                ;;
            *)
                echo "  sudo cp $INSTALL_DIR/deploy/nginx_panel.conf /etc/nginx/conf.d/panel.conf"
                ;;
        esac
    else
        echo "  # Nginx config needs domain configuration"
        case "$PKG_MANAGER" in
            apt-get)
                echo "  sudo cp $INSTALL_DIR/deploy/nginx_game_chrisvanek.conf /etc/nginx/sites-available/panel"
                echo "  sudo ln -s /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/"
                ;;
            *)
                echo "  sudo cp $INSTALL_DIR/deploy/nginx_game_chrisvanek.conf /etc/nginx/conf.d/panel.conf"
                ;;
        esac
    fi
    echo "  sudo nginx -t"
    echo "  sudo systemctl enable nginx"
    echo "  sudo systemctl restart nginx"
    echo
    echo "  # Setup SSL with Let's Encrypt (optional)"
    case "$PKG_MANAGER" in
        apt-get)
            echo "  sudo apt install certbot python3-certbot-nginx"
            ;;
        dnf|yum)
            echo "  sudo $PKG_MANAGER install certbot python3-certbot-nginx"
            ;;
        apk)
            echo "  sudo apk add certbot certbot-nginx"
            ;;
        pacman)
            echo "  sudo pacman -S certbot certbot-nginx"
            ;;
        brew)
            echo "  brew install certbot"
            ;;
    esac
    echo "  sudo certbot --nginx -d $DOMAIN"
    echo
    echo "  # Open firewall ports (if firewall is active)"
    echo "  sudo ufw allow 80/tcp   # HTTP"
    echo "  sudo ufw allow 443/tcp  # HTTPS"
    echo "  sudo ufw allow 8080/tcp # Panel (if not using nginx proxy)"
    echo
}
