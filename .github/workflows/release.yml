name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Get version
      id: get-version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          version="${{ inputs.version }}"
        else
          version="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Version: $version"

    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag
        previous_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

        if [ -n "$previous_tag" ]; then
          echo "## Changes since $previous_tag" > changelog.md
          echo "" >> changelog.md
          git log --pretty=format:"- %s (%h)" "$previous_tag"..HEAD >> changelog.md
        else
          echo "## Initial Release" > changelog.md
          echo "" >> changelog.md
          echo "First release of the Panel application." >> changelog.md
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat changelog.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub release
      id: create-release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get-version.outputs.version }}
        name: Release ${{ steps.get-version.outputs.version }}
        body: |
          ## üöÄ Release ${{ steps.get-version.outputs.version }}

          ${{ steps.changelog.outputs.changelog }}

          ### üîó Links
          - [Docker Image](https://hub.docker.com/r/panel/panel/tags)
          - [Documentation](https://panel.readthedocs.io/)
          - [Changelog](https://github.com/${{ github.repository }}/blob/main/docs/CHANGELOG.md)

          ### üì¶ Installation
          \`\`\`bash
          docker pull panel/panel:${{ steps.get-version.outputs.version }}
          \`\`\`

          ### üîç Verification
          - [x] All tests passing
          - [x] Security scans completed
          - [x] Code quality checks passed
          - [x] Docker image built and scanned
        draft: false
        prerelease: ${{ inputs.prerelease || false }}
        token: ${{ secrets.GITHUB_TOKEN }}

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: release
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          panel/panel
          ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=tag
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        target: production
        platforms: linux/amd64,linux/arm64
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: panel/panel:${{ needs.release.outputs.version }}
        format: spdx-json
        output-file: ./sbom.spdx.json

    - name: Upload SBOM to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.release.outputs.version }}
        files: ./sbom.spdx.json
        token: ${{ secrets.GITHUB_TOKEN }}

  security-scan-release:
    name: Security Scan Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [release, build-and-push]

    steps:
    - name: Run Trivy on release image
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'image'
        scan-ref: 'panel/panel:${{ needs.release.outputs.version }}'
        format: 'sarif'
        output: 'trivy-release-results.sarif'
        exit-code: 1  # Fail on HIGH/CRITICAL vulnerabilities

    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-release-results.sarif

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [release, build-and-push, security-scan-release]
    if: always()

    steps:
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
              "title": "${{ job.status == 'success' && 'üöÄ Release Published' || '‚ùå Release Failed' }}",
              "title_link": "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.release.outputs.version }}",
              "text": "Panel ${{ needs.release.outputs.version }} ${{ job.status == 'success' && 'has been released successfully' || 'release failed' }}",
              "fields": [
                {
                  "title": "Version",
                  "value": "${{ needs.release.outputs.version }}",
                  "short": true
                },
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Docker Image",
                  "value": "panel/panel:${{ needs.release.outputs.version }}",
                  "short": false
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_RELEASE_WEBHOOK_URL }}
