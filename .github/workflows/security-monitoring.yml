name: Security Monitoring

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Optional reason for manual run'
        required: false
        type: string

permissions:
  contents: read
  actions: read
  issues: write
  security-events: write

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        pip install safety bandit pip-audit || true
        # Install jq for JSON parsing
        if ! command -v jq >/dev/null 2>&1; then
          echo "Installing jq..."
          sudo apt-get update -y || true
          sudo apt-get install -y jq || echo "Warning: jq installation failed"
        fi
        # Set up Node.js for audit-ci
        if ! command -v node >/dev/null 2>&1; then
          echo "Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - || true
          sudo apt-get install -y nodejs || echo "Warning: Node.js installation failed"
        fi
        npm install -g audit-ci || true

    - name: Run Safety (Python vulnerabilities)
      if: always()
      run: |
        pip install -r requirements/requirements-prod.txt || echo "Warning: Some dependencies failed to install"
        safety check --output json --save-json safety-report.json || true
        # Check for high/critical vulnerabilities
        if [ -f safety-report.json ]; then
          echo "âœ… Safety check completed"
          # Check if file contains vulnerabilities
          if command -v jq >/dev/null 2>&1; then
            vuln_count=$(jq '.vulnerabilities // [] | length' safety-report.json 2>/dev/null || echo "0")
            if [ "$vuln_count" -gt 0 ]; then
              echo "âš ï¸ Vulnerabilities found: $vuln_count"
              critical_count=$(jq '.vulnerabilities // [] | map(select(.vulnerability.severity == "high" or .vulnerability.severity == "critical")) | length' safety-report.json 2>/dev/null || echo "0")
              if [ "$critical_count" -gt 0 ]; then
                echo "ðŸš¨ High/Critical Python vulnerabilities found: $critical_count"
                echo "high_vulns=true" >> $GITHUB_ENV
              fi
            else
              echo "âœ… No vulnerabilities found"
            fi
          else
            echo "âš ï¸ jq not available, skipping detailed vulnerability check"
          fi
        else
          echo "âš ï¸ Safety report not generated"
        fi

    - name: Run pip-audit
      if: always()
      run: |
        pip install -r requirements/requirements-prod.txt || echo "Warning: Some dependencies failed to install"
        pip-audit --format json --output pip-audit-report.json || true
        # Check for vulnerabilities
        if [ -f pip-audit-report.json ]; then
          if command -v jq >/dev/null 2>&1; then
            vuln_count=$(jq 'if type == "array" then length elif type == "object" then (.dependencies // [] | length) else 0 end' pip-audit-report.json 2>/dev/null || echo "0")
            if [ "$vuln_count" -gt 0 ]; then
              echo "âš ï¸ pip-audit found $vuln_count issue(s)"
              cat pip-audit-report.json | head -n 50
            else
              echo "âœ… No pip-audit issues found"
            fi
          else
            echo "âš ï¸ jq not available, pip-audit results may contain issues"
            if [ -s pip-audit-report.json ]; then
              echo "âš ï¸ pip-audit report generated but cannot parse without jq"
            else
              echo "âœ… pip-audit completed (empty report)"
            fi
          fi
        else
          echo "âš ï¸ pip-audit report not generated"
        fi

    - name: Run Bandit (Python security)
      if: always()
      run: |
        pip install -r requirements/requirements-prod.txt || echo "Warning: Some dependencies failed to install"
        bandit -r . -f json -o bandit-report.json --exclude ./tests,./venv,./.venv,./node_modules || true
        # Check for high-severity issues
        if [ -f bandit-report.json ]; then
          if command -v jq >/dev/null 2>&1; then
            high_issues=$(jq '.results // [] | map(select(.issue_severity == "HIGH")) | length' bandit-report.json 2>/dev/null || echo "0")
            if [ "$high_issues" -gt 0 ]; then
              echo "ðŸš¨ High-severity security issues found: $high_issues"
              jq '.results // [] | map(select(.issue_severity == "HIGH"))' bandit-report.json | head -n 50
              echo "bandit_high=true" >> $GITHUB_ENV
            else
              echo "âœ… No high-severity code security issues found"
            fi
            # Show summary
            total_issues=$(jq '.results // [] | length' bandit-report.json 2>/dev/null || echo "0")
            echo "Total issues found: $total_issues"
          else
            echo "âš ï¸ jq not available, cannot parse Bandit results"
            if [ -s bandit-report.json ]; then
              echo "âš ï¸ Bandit report generated but cannot parse without jq"
            fi
          fi
        else
          echo "âš ï¸ Bandit report not generated"
        fi

    - name: Run Trivy (container vulnerabilities)
      # Pin to a stable version to avoid breaking changes
      uses: aquasecurity/trivy-action@v0.16.1
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-files-report.json'
        exit-code: 0  # Don't fail, just report

    - name: Analyze Trivy results
      if: always()
      run: |
        if [ -f trivy-files-report.json ]; then
          if command -v jq >/dev/null 2>&1; then
            high_vulns=$(jq '[.Results // [] | .[] | .Vulnerabilities // [] | .[] | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-files-report.json 2>/dev/null || echo "0")
            if [ "$high_vulns" -gt 0 ]; then
              echo "ðŸš¨ High/Critical container vulnerabilities found!"
              jq '[.Results // [] | .[] | .Vulnerabilities // [] | .[] | select(.Severity == "HIGH" or .Severity == "CRITICAL") | {Package: .PkgName, Version: .InstalledVersion, Severity: .Severity, Description: .Description}]' trivy-files-report.json
              echo "trivy_high=true" >> $GITHUB_ENV
            else
              echo "âœ… No high/critical container vulnerabilities found"
            fi
          else
            echo "âš ï¸ jq not available, cannot parse Trivy results"
            if [ -s trivy-files-report.json ]; then
              echo "âš ï¸ Trivy report generated but cannot parse without jq"
            fi
          fi
        fi

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: Check for additional security issues
      run: |
        echo "Checking for additional security configurations..."
        # Check for exposed secrets in environment files
        if [ -f ".env" ] || [ -f ".env.local" ]; then
          echo "âš ï¸ Warning: Environment files found in repository"
        else
          echo "âœ… No environment files in repository"
        fi

    - name: Generate security report
      if: always()
      run: |
        echo "# Security Audit Report" > security-summary.md
        echo "" >> security-summary.md
        echo "Generated on: $(date)" >> security-summary.md
        echo "Commit: ${{ github.sha }}" >> security-summary.md
        echo "" >> security-summary.md

        if [ "${{ env.high_vulns }}" = "true" ] || [ "${{ env.bandit_high }}" = "true" ] || [ "${{ env.trivy_high }}" = "true" ]; then
          echo "## ðŸš¨ CRITICAL ISSUES FOUND" >> security-summary.md
          echo "" >> security-summary.md
          [ "${{ env.high_vulns }}" = "true" ] && echo "- High/Critical Python package vulnerabilities" >> security-summary.md
          [ "${{ env.bandit_high }}" = "true" ] && echo "- High-severity code security issues" >> security-summary.md
          [ "${{ env.trivy_high }}" = "true" ] && echo "- High/Critical container vulnerabilities" >> security-summary.md
          echo "" >> security-summary.md
        else
          echo "## âœ… NO CRITICAL ISSUES" >> security-summary.md
          echo "" >> security-summary.md
        fi

        echo "## Scan Results" >> security-summary.md
        echo "" >> security-summary.md
        echo "### Safety (Python Dependencies)" >> security-summary.md
        if [ -f safety-report.json ]; then
          vuln_count=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
          echo "- Vulnerabilities found: $vuln_count" >> security-summary.md
        fi

        echo "" >> security-summary.md
        echo "### Bandit (Code Security)" >> security-summary.md
        if [ -f bandit-report.json ]; then
          high_count=$(jq '.results // [] | map(select(.issue_severity == "HIGH")) | length' bandit-report.json 2>/dev/null || echo "0")
          med_count=$(jq '.results // [] | map(select(.issue_severity == "MEDIUM")) | length' bandit-report.json 2>/dev/null || echo "0")
          echo "- High severity: $high_count" >> security-summary.md
          echo "- Medium severity: $med_count" >> security-summary.md
        fi

        echo "" >> security-summary.md
        echo "### Trivy (Container Security)" >> security-summary.md
        if [ -f trivy-files-report.json ]; then
          high_count=$(jq '[.Results // [] | .[] | .Vulnerabilities // [] | .[] | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-files-report.json 2>/dev/null || echo "0")
          echo "- High/Critical: $high_count" >> security-summary.md
        fi

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-reports
        path: |
          safety-report.json
          pip-audit-report.json
          bandit-report.json
          trivy-files-report.json
          security-summary.md
        retention-days: 30

    - name: Create security issue on failures
      if: env.high_vulns == 'true' || env.bandit_high == 'true' || env.trivy_high == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let body = '## ðŸš¨ Security Issues Detected\n\n';
          body += 'Critical security issues were found during automated scanning:\n\n';

          if (process.env.high_vulns === 'true') body += '- High/Critical Python package vulnerabilities\n';
          if (process.env.bandit_high === 'true') body += '- High-severity code security issues\n';
          if (process.env.trivy_high === 'true') body += '- High/Critical container vulnerabilities\n';

          body += '\n### Next Steps\n';
          body += '1. Review the security reports in the workflow artifacts\n';
          body += '2. Update vulnerable dependencies\n';
          body += '3. Fix code security issues\n';
          body += '4. Re-run security scans\n\n';
          body += 'See workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Critical Security Issues Detected',
            body: body,
            labels: ['security', 'critical', 'automated']
          });

    - name: Notify Slack on security issues
      if: env.high_vulns == 'true' || env.bandit_high == 'true' || env.trivy_high == 'true'
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "attachments": [{
              "color": "danger",
              "title": "ðŸš¨ Security Issues Detected",
              "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "text": "Critical security vulnerabilities found in ${{ github.repository }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref_name }}",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "${{ github.sha }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK_URL }}