#cloud-config
# Enhanced Cloud-init for Ubuntu 22.04 - Panel with SQLite
# Production-ready with security hardening
#
# Usage: Copy this file content to your cloud provider's user-data field
# Tested on: AWS EC2, Google Cloud, Azure, DigitalOcean
#
# Deployment time: ~10-15 minutes
# Resources: 1 vCPU, 1GB RAM minimum

# System update and upgrade
package_update: true
package_upgrade: true

# Required packages
packages:
  - git
  - curl
  - python3-venv
  - python3-pip
  - ufw
  - fail2ban
  - unattended-upgrades
  - certbot
  - python3-certbot-nginx
  - nginx

# Write configuration files
write_files:
  # UFW application profile for Panel
  - path: /etc/ufw/applications.d/panel
    content: |
      [Panel]
      title=Panel Application
      description=Game server management panel
      ports=80,443/tcp
    permissions: '0644'

  # fail2ban configuration for Panel
  - path: /etc/fail2ban/jail.d/panel.conf
    content: |
      [panel]
      enabled = true
      port = http,https
      filter = panel
      logpath = /opt/panel/logs/*.log
      maxretry = 5
      bantime = 3600
      findtime = 600
    permissions: '0644'

  # Automatic security updates configuration
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
        "${distro_id}ESMApps:${distro_codename}-apps-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
      Unattended-Upgrade::Mail "root";
    permissions: '0644'

  # Panel deployment script
  - path: /tmp/deploy-panel.sh
    content: |
      #!/bin/bash
      set -euo pipefail
      
      # Logging
      exec 1> >(tee -a /var/log/panel-deployment.log)
      exec 2>&1
      
      echo "=== Panel Deployment Started at $(date) ==="
      
      # Configuration (override via cloud-init variables)
      export PANEL_NON_INTERACTIVE=true
      export PANEL_DB_TYPE=${PANEL_DB_TYPE:-sqlite}
      export PANEL_INSTALL_DIR=${PANEL_INSTALL_DIR:-/opt/panel}
      export PANEL_ADMIN_EMAIL=${PANEL_ADMIN_EMAIL:-admin@example.com}
      
      # Generate secure admin password if not provided
      if [ -z "${PANEL_ADMIN_PASS:-}" ]; then
        export PANEL_ADMIN_PASS=$(openssl rand -base64 32)
        echo "Generated admin password: $PANEL_ADMIN_PASS" > /root/panel-credentials.txt
        chmod 600 /root/panel-credentials.txt
        echo "? Generated secure admin password (saved to /root/panel-credentials.txt)"
      else
        echo "? Using provided admin password"
      fi
      
      # Create install directory
      echo "Creating install directory: $PANEL_INSTALL_DIR"
      mkdir -p "$PANEL_INSTALL_DIR"
      mkdir -p "$PANEL_INSTALL_DIR/logs"
      mkdir -p "$PANEL_INSTALL_DIR/backups"
      chown -R ubuntu:ubuntu "$PANEL_INSTALL_DIR"
      
      # Clone repository
      echo "Cloning Panel repository..."
      cd /tmp
      if [ -d "panel-src" ]; then
        echo "Repository exists, updating..."
        cd panel-src
        git pull || echo "Warning: git pull failed, continuing with existing code"
      else
        if ! git clone https://github.com/phillgates2/panel.git panel-src; then
          echo "? Failed to clone repository"
          exit 1
        fi
        cd panel-src
      fi
      
      echo "? Repository ready"
      
      # Run installer
      echo "Running Panel installer..."
      if bash install.sh \
        --non-interactive \
        --sqlite \
        --dir "$PANEL_INSTALL_DIR"; then
        echo "? Installer completed successfully"
      else
        echo "? Installer failed (exit code: $?)"
        echo "Check installation log at: $PANEL_INSTALL_DIR/install.log"
        exit 1
      fi
      
      # Verify installation
      echo "Verifying installation..."
      if [ ! -f "$PANEL_INSTALL_DIR/app.py" ]; then
        echo "? Verification failed: app.py not found"
        exit 1
      fi
      
      if [ ! -d "$PANEL_INSTALL_DIR/venv" ]; then
        echo "? Verification failed: virtual environment not found"
        exit 1
      fi
      
      echo "? Installation files verified"
      
      # Start Panel service
      echo "Starting Panel service..."
      if systemctl enable panel 2>/dev/null; then
        echo "? Panel service enabled"
      else
        echo "? Warning: Could not enable Panel service"
      fi
      
      if systemctl start panel 2>/dev/null; then
        echo "? Panel service started"
        sleep 3
        systemctl status panel --no-pager || true
      else
        echo "? Warning: Could not start Panel service"
      fi
      
      # Test application
      echo "Testing application..."
      if curl -sf http://localhost:5000 > /dev/null; then
        echo "? Application is responding"
      else
        echo "? Warning: Application not responding on port 5000"
      fi
      
      echo "=== Panel Deployment Completed at $(date) ==="
      echo ""
      echo "Next steps:"
      echo "1. Review logs: /var/log/panel-deployment.log"
      echo "2. Check credentials: /root/panel-credentials.txt"
      echo "3. Configure DNS for your domain"
      echo "4. Run: sudo certbot --nginx -d yourdomain.com"
      echo "5. Access Panel at: http://$(curl -s ifconfig.me)"
    permissions: '0755'

# System configuration commands
runcmd:
  # Configure firewall
  - [ bash, -c, "echo 'Configuring firewall...'" ]
  - [ bash, -c, "ufw --force enable" ]
  - [ bash, -c, "ufw default deny incoming" ]
  - [ bash, -c, "ufw default allow outgoing" ]
  - [ bash, -c, "ufw allow ssh comment 'Allow SSH'" ]
  - [ bash, -c, "ufw allow 'Panel' comment 'Allow Panel HTTP/HTTPS'" ]
  - [ bash, -c, "ufw --force reload" ]
  - [ bash, -c, "echo '? Firewall configured'" ]

  # SSH hardening
  - [ bash, -c, "echo 'Hardening SSH...'" ]
  - [ bash, -c, "cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup" ]
  - [ bash, -c, "sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config" ]
  - [ bash, -c, "sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config" ]
  - [ bash, -c, "sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config" ]
  - [ bash, -c, "systemctl restart sshd" ]
  - [ bash, -c, "echo '? SSH hardened'" ]

  # Start fail2ban
  - [ bash, -c, "echo 'Starting fail2ban...'" ]
  - [ bash, -c, "systemctl enable fail2ban" ]
  - [ bash, -c, "systemctl start fail2ban" ]
  - [ bash, -c, "echo '? fail2ban started'" ]

  # Enable automatic security updates
  - [ bash, -c, "echo 'Enabling automatic security updates...'" ]
  - [ bash, -c, "systemctl enable unattended-upgrades" ]
  - [ bash, -c, "systemctl start unattended-upgrades" ]
  - [ bash, -c, "echo '? Automatic security updates enabled'" ]

  # Deploy Panel
  - [ bash, -c, "echo 'Deploying Panel application...'" ]
  - [ bash, -c, "/tmp/deploy-panel.sh" ]

  # Setup monitoring cron job
  - [ bash, -c, "echo 'Setting up monitoring...'" ]
  - [ bash, -c, "(crontab -l 2>/dev/null; echo '*/5 * * * * systemctl is-active --quiet panel || systemctl restart panel') | crontab -" ]
  - [ bash, -c, "(crontab -l 2>/dev/null; echo '0 2 * * * cp /opt/panel/instance/panel.db /opt/panel/backups/panel_$(date +\\%Y\\%m\\%d).db') | crontab -" ]
  - [ bash, -c, "echo '? Monitoring configured'" ]

# Final message
final_message: |
  ???????????????????????????????????????????????????????????
  Panel Deployment Complete! ??
  ???????????????????????????????????????????????????????????
  
  ?? Installation: /opt/panel/
  ?? Deployment log: /var/log/panel-deployment.log
  ?? Credentials: /root/panel-credentials.txt
  
  ?? Next Steps:
  ???????????????
  1. SSH into server: ssh ubuntu@YOUR_SERVER_IP
  2. View credentials: sudo cat /root/panel-credentials.txt
  3. Configure DNS to point to this server
  4. Setup SSL: sudo certbot --nginx -d your-domain.com
  5. Access Panel: http://YOUR_SERVER_IP
  
  ??? Security Features Enabled:
  ?????????????????????????????
  ? UFW firewall (ports 22, 80, 443 open)
  ? fail2ban (brute force protection)
  ? Automatic security updates
  ? SSH hardening (root login disabled)
  ? Daily database backups
  ? Service monitoring (restart on failure)
  
  ?? Documentation:
  ?????????????????
  - Installation logs: /opt/panel/install.log
  - Application logs: /opt/panel/logs/
  - Service status: systemctl status panel
  
  ?? Important:
  ?????????????
  - Change default admin password on first login
  - Configure DNS before requesting SSL certificate
  - Review firewall rules for your use case
  
  System ready at: $TIMESTAMP
  ???????????????????????????????????????????????????????????
