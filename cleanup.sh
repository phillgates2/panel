#!/bin/bash
# cleanup.sh - Automated Panel workspace cleanup
# Usage: bash cleanup.sh

set -e

echo "????????????????????????????????????????????????????????????"
echo "?         Panel Workspace Cleanup & Verification           ?"
echo "????????????????????????????????????????????????????????????"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
WARNINGS=0
ERRORS=0
SUCCESS=0

# 1. Remove Python cache
echo "???????????????????????????????????????????????????????"
echo "1. Cleaning Python cache files..."
echo "???????????????????????????????????????????????????????"
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
find . -type f -name "*.pyo" -delete 2>/dev/null || true
find . -type f -name "*.pyd" -delete 2>/dev/null || true
echo "? Python cache cleaned"
((SUCCESS++))

# 2. Check .gitignore
echo ""
echo "???????????????????????????????????????????????????????"
echo "2. Checking .gitignore..."
echo "???????????????????????????????????????????????????????"

GITIGNORE_ENTRIES=(
    "__pycache__/"
    "*.py[cod]"
    ".env"
    "config/config.*.json"
    "*.log"
    "*.db"
    "*.sqlite"
)

MISSING_ENTRIES=()
for entry in "${GITIGNORE_ENTRIES[@]}"; do
    if ! grep -q "$entry" .gitignore 2>/dev/null; then
        MISSING_ENTRIES+=("$entry")
    fi
done

if [ ${#MISSING_ENTRIES[@]} -eq 0 ]; then
    echo "? .gitignore is complete"
    ((SUCCESS++))
else
    echo "? Missing .gitignore entries:"
    for entry in "${MISSING_ENTRIES[@]}"; do
        echo "  - $entry"
    done
    ((WARNINGS++))
    
    read -p "Add missing entries to .gitignore? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        for entry in "${MISSING_ENTRIES[@]}"; do
            echo "$entry" >> .gitignore
        done
        echo "? .gitignore updated"
    fi
fi

# 3. Check migration chain
echo ""
echo "???????????????????????????????????????????????????????"
echo "3. Checking migration chain..."
echo "???????????????????????????????????????????????????????"
if [ -f "tools/scripts/fix_migration_chain.py" ]; then
    if python tools/scripts/fix_migration_chain.py 2>&1 | grep -q "Migration chain is valid"; then
        echo "? Migration chain is valid"
        ((SUCCESS++))
    else
        echo "? Migration chain has issues"
        echo "  Run: python tools/scripts/fix_migration_chain.py --fix"
        ((WARNINGS++))
    fi
else
    echo "? Migration fix script not found"
    ((WARNINGS++))
fi

# 4. Check for hardcoded secrets
echo ""
echo "???????????????????????????????????????????????????????"
echo "4. Scanning for hardcoded secrets..."
echo "???????????????????????????????????????????????????????"

# Check config files specifically
echo "Checking config/*.json files..."
if ls config/*.json >/dev/null 2>&1; then
    SECRETS_FOUND=$(grep -E "(password|secret|key|token).*:.*\"[^\"]{8,}\"" config/*.json 2>/dev/null || true)
    if [ -n "$SECRETS_FOUND" ]; then
        echo "? Potential secrets found in config/*.json:"
        echo "$SECRETS_FOUND"
        echo ""
        echo "? CRITICAL: Review these files for hardcoded credentials"
        echo "  See: docs/CONFIG_FOLDER_ANALYSIS.md"
        ((WARNINGS++))
    else
        echo "? No obvious secrets in config files"
        ((SUCCESS++))
    fi
else
    echo "? No JSON config files found"
    ((SUCCESS++))
fi

# 5. Check for duplicate folders
echo ""
echo "???????????????????????????????????????????????????????"
echo "5. Checking for duplicate folders..."
echo "???????????????????????????????????????????????????????"
if [ -d "infra" ] && [ -d "infrastructure" ]; then
    echo "? Both 'infra' and 'infrastructure' directories exist"
    echo "  Consider consolidating these folders"
    ((WARNINGS++))
else
    echo "? No duplicate infrastructure folders"
    ((SUCCESS++))
fi

# 6. Verify app structure
echo ""
echo "???????????????????????????????????????????????????????"
echo "7. Verifying app structure..."
echo "???????????????????????????????????????????????????????"
if python -c "from app import create_app; app = create_app(); print('? App imports successfully')" 2>&1; then
    ((SUCCESS++))
else
    echo "? App import failed - check app structure"
    ((ERRORS++))
fi

# 7. Check documentation
echo ""
echo "???????????????????????????????????????????????????????"
echo "8. Checking documentation..."
echo "???????????????????????????????????????????????????????"

REQUIRED_DOCS=(
    "docs/MASTER_SUMMARY.md"
    "docs/QUICK_REFERENCE.txt"
    "docs/INDEX.md"
    "docs/MIGRATION_ISSUES_REPORT.md"
    "docs/APP_FOLDER_ANALYSIS.md"
    "docs/GITHUB_WORKFLOWS_ANALYSIS.md"
    "docs/CLOUD_INIT_ANALYSIS.md"
    "docs/CONFIG_FOLDER_ANALYSIS.md"
)

MISSING_DOCS=0
for doc in "${REQUIRED_DOCS[@]}"; do
    if [ ! -f "$doc" ]; then
        echo "? Missing: $doc"
        ((MISSING_DOCS++))
    fi
done

if [ $MISSING_DOCS -eq 0 ]; then
    echo "? All required documentation present"
    ((SUCCESS++))
else
    echo "? Missing $MISSING_DOCS documentation files"
    ((WARNINGS++))
fi

# 8. Check Python dependencies
echo ""
echo "???????????????????????????????????????????????????????"
echo "9. Checking Python dependencies..."
echo "???????????????????????????????????????????????????????"
if [ -f "requirements.txt" ] || [ -d "requirements" ]; then
    echo "? Requirements files found"
    
    # Check if safety is installed
    if command -v safety &> /dev/null; then
        echo "Running security scan..."
        if safety check 2>&1 | grep -q "No known security vulnerabilities"; then
            echo "? No known security vulnerabilities"
            ((SUCCESS++))
        else
            echo "? Security vulnerabilities found - run 'safety check' for details"
            ((WARNINGS++))
        fi
    else
        echo "? 'safety' not installed - cannot check for vulnerabilities"
        echo "  Install: pip install safety"
        ((WARNINGS++))
    fi
else
    echo "? No requirements files found"
    ((WARNINGS++))
fi

# 9. Final summary
echo ""
echo "????????????????????????????????????????????????????????????"
echo "?                   Cleanup Summary                        ?"
echo "????????????????????????????????????????????????????????????"
echo ""
echo "? Success:  $SUCCESS"
echo "? Warnings: $WARNINGS"
echo "? Errors:   $ERRORS"
echo ""

if [ $ERRORS -gt 0 ]; then
    echo "Status: ? ERRORS FOUND - Review output above"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo "Status: ? WARNINGS - Review and address warnings"
    echo ""
    echo "Priority actions:"
    echo "1. Review config/*.json for hardcoded credentials"
    echo "2. Update .gitignore if needed"
    echo "3. Run: python tools/scripts/fix_migration_chain.py --fix"
    echo "4. See: docs/FINAL_CLEANUP_PLAN.md"
else
    echo "Status: ? ALL CHECKS PASSED"
    echo ""
    echo "Workspace is clean and ready!"
fi

echo ""
echo "For complete analysis, see:"
echo "  - docs/MASTER_SUMMARY.md"
echo "  - docs/FINAL_CLEANUP_PLAN.md"
echo "  - docs/QUICK_REFERENCE.txt"
echo ""
