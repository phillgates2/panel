# Makefile for Panel Development
# Comprehensive utility commands for development, testing, and deployment

.PHONY: help install install-dev install-prod clean lint format test test-cov test-unit test-integration test-e2e coverage docs build deploy dev-server prod-server db-init db-migrate db-seed db-reset db-backup db-restore redis-start redis-stop redis-restart logs logs-follow backup restore check-security check-deps update-deps docker-build docker-run docker-stop docker-clean setup-dev setup-prod setup-ci ci-lint ci-test ci-build ci-deploy api-docs deps-check deps-update deps-security deps-report config-init config-setup config-validate config-list config-show config-update config-encrypt config-decrypt config-backup config-restore

# Default target
help: ## Show this help message
	@echo "Panel Development Makefile"
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'

# =============================================================================
# INSTALLATION & SETUP
# =============================================================================

install: ## Install production dependencies
	pip install -r requirements/requirements.txt

install-dev: ## Install development dependencies
	pip install -r requirements/requirements-dev.txt

install-prod: ## Install production dependencies only
	pip install --no-dev -r requirements/requirements.txt

setup-dev: ## Complete development environment setup
	@echo "Setting up development environment..."
	python -m venv .venv
	source .venv/bin/activate && make install-dev
	cp config.py.example config.py || echo "No config.py.example found"
	make db-init
	make db-seed
	@echo "Development setup complete! Run 'make dev-server' to start."

setup-prod: ## Production environment setup
	@echo "Setting up production environment..."
	make install-prod
	make db-init
	make db-migrate
	@echo "Production setup complete!"

setup-ci: ## CI environment setup
	pip install -r requirements/requirements-dev.txt
	pre-commit install

# =============================================================================
# DEVELOPMENT SERVER
# =============================================================================

dev-server: ## Start development server with hot reload
	@echo "Starting enhanced development server..."
	python tools/scripts/dev_server.py

prod-server: ## Start production server
	@echo "Starting production server..."
	export FLASK_ENV=production && gunicorn --bind 0.0.0.0:8080 --workers 4 app:create_app

# =============================================================================
# DATABASE MANAGEMENT
# =============================================================================

db-init: ## Initialize database
	@echo "Initializing database..."
	export FLASK_ENV=development && python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.create_all()"}

db-migrate: ## Create new database migration
	@echo "Enter migration message:" && read message && \
	export FLASK_ENV=development && flask db migrate -m "$$message"

db-upgrade: ## Upgrade database to latest migration
	export FLASK_ENV=development && flask db upgrade

db-downgrade: ## Downgrade database
	@echo "Enter revision to downgrade to (or -1 for previous):" && read rev && \
	export FLASK_ENV=development && flask db downgrade $$rev

db-history: ## Show migration history
	export FLASK_ENV=development && flask db history

db-seed: ## Seed database with sample data
	@echo "Seeding database with sample data..."
	export FLASK_ENV=development && python tools/scripts/db_seed.py

db-reset: ## Reset database (WARNING: destroys all data)
	@echo "Resetting database..."
	@echo "This will destroy all data. Are you sure? [y/N] " && read ans && [ $${ans:-N} = y ]
	export FLASK_ENV=development && python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.drop_all(); db.create_all()"
	make db-seed

db-backup: ## Backup database
	@echo "Backing up database..."
	python tools/scripts/backup_manager.py backup

db-restore: ## Restore database from backup
	@echo "Available backups:"
	python tools/scripts/backup_manager.py list
	@echo "Enter backup filename to restore:" && read filename
	python tools/scripts/backup_manager.py restore $$filename

db-optimize: ## Optimize database with indexes
	@echo "Optimizing database..."
	export FLASK_ENV=development && python -c "from src.panel.db_optimization import create_database_indexes; create_database_indexes()"

db-report: ## Show database performance report
	@echo "Generating database performance report..."
	export FLASK_ENV=development && python -c "
from src.panel.db_optimization import get_query_profiler
profiler = get_query_profiler()
report = profiler.get_performance_report()
print('=== Database Performance Report ===')
print(f'Total Queries: {report[\"total_queries\"]}')
print(f'Slow Queries: {len(report[\"slow_queries\"])}')
print(f'Index Recommendations: {len(report[\"index_recommendations\"])}')
for rec in report['index_recommendations'][:5]:
    print(f'  - {rec[\"table\"]}.{rec[\"column\"]}: {rec[\"reason\"]}')
"

# =============================================================================
# RATE LIMITING MANAGEMENT
# =============================================================================

rate-limit-stats: ## Show rate limiting statistics
	@echo "Rate limiting statistics..."
	curl -s http://localhost:8080/admin/rate-limiting/stats | jq .

rate-limit-block: ## Block an IP (usage: make rate-limit-block IP=1.2.3.4)
	@echo "Blocking IP: $(IP)..."
	curl -X POST http://localhost:8080/admin/rate-limiting/block/$(IP)

rate-limit-unblock: ## Unblock an IP (usage: make rate-limit-unblock IP=1.2.3.4)
	@echo "Unblocking IP: $(IP)..."
	curl -X POST http://localhost:8080/admin/rate-limiting/unblock/$(IP)

# =============================================================================
# OAUTH MANAGEMENT
# =============================================================================

oauth-setup: ## Setup OAuth providers (requires environment variables)
	@echo "OAuth providers configured:"
	@echo "Google: $$(if [ -n "$$GOOGLE_CLIENT_ID" ]; then echo "? Enabled"; else echo "? Not configured"; fi)"
	@echo "GitHub: $$(if [ -n "$$GITHUB_CLIENT_ID" ]; then echo "? Enabled"; else echo "? Not configured"; fi)"
	@echo "Discord: $$(if [ -n "$$DISCORD_CLIENT_ID" ]; then echo "? Enabled"; else echo "? Not configured"; fi)"

# =============================================================================
# GDPR MANAGEMENT
# =============================================================================

gdpr-cleanup: ## Run GDPR data retention cleanup
	@echo "Running GDPR data retention cleanup..."
	export FLASK_ENV=development && flask cleanup-retention

# =============================================================================
# PWA MANAGEMENT
# =============================================================================

pwa-generate-icons: ## Generate PWA icons from logo
	@echo "Generating PWA icons..."
	@echo "Note: This requires ImageMagick. Run manually:"
	@echo "convert static/logo.png -resize 192x192 static/icons/icon-192.png"
	@echo "convert static/logo.png -resize 512x512 static/icons/icon-512.png"

pwa-test: ## Test PWA functionality
	@echo "Testing PWA features..."
	@echo "1. Check manifest: curl http://localhost:8080/static/manifest.json"
	@echo "2. Check service worker: curl http://localhost:8080/static/sw.js"
	@echo "3. Test offline page: curl http://localhost:8080/offline"
	@echo "4. Check push VAPID key: curl http://localhost:8080/api/push/vapid-public-key"

# =============================================================================
# REAL-TIME FEATURES MANAGEMENT
# =============================================================================

realtime-status: ## Check real-time features status
	@echo "Real-time features status:"
	@echo "WebSocket server: $$(if pgrep -f "socketio" > /dev/null; then echo "✓ Running"; else echo "✗ Not running"; fi)"
	@echo "Redis connection: $$(python -c "from src.panel.services.cache_service import get_cache_service; print('✓ Connected' if get_cache_service() else '✗ Failed')")"
	@echo "Active connections: Check logs for connection counts"

realtime-test: ## Test real-time features
	@echo "Testing real-time features..."
	@echo "1. WebSocket connection: Open browser console on any page"
	@echo "2. Forum real-time: Visit a forum thread and watch for updates"
	@echo "3. Server status: Check dashboard for live server updates"
	@echo "4. User status: Monitor user online/offline indicators"

# =============================================================================
# MICROservices MANAGEMENT
# =============================================================================

microservices-init: ## Initialize microservices architecture
	@echo "Initializing microservices architecture..."
	export MICROSERVICES_ENABLED=true && export API_GATEWAY_ENABLED=true

microservices-up: ## Start microservices with Docker Compose
	@echo "Starting microservices..."
	docker-compose -f docker-compose.microservices.yml up -d

microservices-down: ## Stop microservices
	@echo "Stopping microservices..."
	docker-compose -f docker-compose.microservices.yml down

microservices-logs: ## View microservices logs
	docker-compose -f docker-compose.microservices.yml logs -f

microservices-health: ## Check microservices health
	@echo "API Gateway:" && curl -s http://localhost:5000/api/v2/health | jq . || echo "Not available"
	@echo "Auth Service:" && curl -s http://localhost:5001/health | jq . || echo "Not available"
	@echo "Forum Service:" && curl -s http://localhost:5002/health | jq . || echo "Not available"
	@echo "CMS Service:" && curl -s http://localhost:5003/health | jq . || echo "Not available"
	@echo "Admin Service:" && curl -s http://localhost:5004/health | jq . || echo "Not available"

# =============================================================================
# CDN MANAGEMENT
# =============================================================================

cdn-status: ## Check CDN integration status
	@echo "CDN Status:"
	@echo "CDN Enabled: $$(if [ -n "$$CDN_URL" ]; then echo "✓ Yes"; else echo "✗ No"; fi)"
	@echo "CDN URL: $$CDN_URL"
	@echo "CDN Provider: $$CDN_PROVIDER"

cdn-invalidate: ## Invalidate CDN cache (usage: make cdn-invalidate ASSET=path/to/asset)
	@echo "Invalidating CDN cache for: $(ASSET)"
	python -c "
from src.panel.cdn_integration import invalidate_cdn_cache
invalidate_cdn_cache('$(ASSET)')
"

cdn-stats: ## Show CDN statistics
	@echo "CDN Statistics:"
	python -c "
from src.panel.cdn_integration import get_cdn_stats
import json
stats = get_cdn_stats()
print(json.dumps(stats, indent=2))
"

# =============================================================================
# TESTING & MONITORING
# =============================================================================

test: ## Run all tests
	@echo "Running all tests..."
	pytest

test-cov: ## Run tests with coverage
	@echo "Running tests with coverage report..."
	pytest --cov=src --cov-report=html --cov-report=term

test-unit: ## Run unit tests
	@echo "Running unit tests..."
	pytest tests/unit/

test-integration: ## Run integration tests
	@echo "Running integration tests..."
	pytest tests/integration/

test-e2e: ## Run end-to-end tests with Playwright
	@echo "Running E2E tests..."
	playwright install
	pytest tests/e2e/ -v --tb=short --headed=false

test-e2e-headed: ## Run E2E tests with browser visible
	@echo "Running E2E tests (headed)..."
	playwright install
	pytest tests/e2e/ -v --tb=short --headed=true

test-e2e-debug: ## Debug E2E tests
	@echo "Debugging E2E tests..."
	playwright install
	PWDEBUG=1 pytest tests/e2e/test_authentication.py::TestAuthentication::test_user_login -v

test-load: ## Run load tests with Locust
	@echo "Running load tests..."
	locust -f tests/load/locustfile.py --host=http://localhost:8080 --users=$(LOAD_TEST_USERS) --spawn-rate=$(LOAD_TEST_SPAWN_RATE) --run-time=$(LOAD_TEST_DURATION) --headless

test-load-web: ## Run load tests with web UI
	@echo "Starting load test web UI..."
	locust -f tests/load/locustfile.py --host=http://localhost:8080 --web-host=0.0.0.0 --web-port=8089

test-performance: ## Run performance monitoring
	@echo "Performance monitoring active..."
	@echo "Metrics endpoint: http://localhost:8080/api/monitoring/metrics"
	@echo "Health check: http://localhost:8080/api/monitoring/health"
	@echo "System info: http://localhost:8080/api/monitoring/system"

test-playwright-install: ## Install Playwright browsers
	playwright install

test-playwright-codegen: ## Generate Playwright test code
	@echo "Generating test code..."
	playwright codegen http://localhost:8080

test-accessibility: ## Run accessibility tests
	@echo "Running accessibility tests..."
	pytest tests/e2e/test_accessibility.py -v

test-visual-regression: ## Run visual regression tests
	@echo "Running visual regression tests..."
	pytest tests/e2e/test_visual_regression.py -v

# =============================================================================
# API MANAGEMENT
# =============================================================================

api-docs: ## Generate and serve API documentation
	@echo "API Documentation available at:"
	@echo "Swagger UI: http://localhost:8080/api/v1/docs"
	@echo "OpenAPI JSON: http://localhost:8080/api/v1/swagger.json"
	@echo "ReDoc: http://localhost:8080/api/v1/redoc"

# =============================================================================
# DEPENDENCY MANAGEMENT
# =============================================================================

deps-check: ## Check for outdated dependencies
	@echo "Checking for outdated dependencies..."
	./scripts/update-dependencies.sh check

deps-update: ## Update all dependencies
	@echo "Updating dependencies..."
	./scripts/update-dependencies.sh all

deps-security: ## Run dependency security audit
	@echo "Running dependency security audit..."
	./scripts/update-dependencies.sh security

deps-report: ## Generate dependency update report
	@echo "Generating dependency report..."
	./scripts/update-dependencies.sh report

# =============================================================================
# CONFIGURATION MANAGEMENT
# =============================================================================

config-init: ## Initialize configuration system
	@echo "Initializing configuration system..."
	./scripts/manage-config.sh init

config-setup: ## Setup configuration for current environment (usage: make config-setup ENV=development)
	@echo "Setting up configuration for $(ENV)..."
	./scripts/manage-config.sh setup $(ENV)

config-validate: ## Validate all environment configurations
	@echo "Validating configurations..."
	./scripts/manage-config.sh validate

config-list: ## List all environments and their status
	@echo "Available environments:"
	./scripts/manage-config.sh list

config-show: ## Show configuration for environment (usage: make config-show ENV=development)
	@echo "Configuration for $(ENV):"
	./scripts/manage-config.sh show $(ENV)

config-update: ## Update configuration value (usage: make config-update ENV=development KEY=debug VALUE=true)
	@echo "Updating $(ENV) config: $(KEY) = $(VALUE)"
	./scripts/manage-config.sh update $(ENV) $(KEY) $(VALUE)

config-encrypt: ## Encrypt and store a secret (usage: make config-encrypt KEY=db_password VALUE=secret123)
	@echo "Encrypting secret: $(KEY)"
	./scripts/manage-config.sh encrypt $(KEY) $(VALUE)

config-decrypt: ## Decrypt and show a secret (usage: make config-decrypt KEY=db_password)
	@echo "Decrypting secret: $(KEY)"
	./scripts/manage-config.sh decrypt $(KEY)

config-backup: ## Create backup of all configurations
	@echo "Creating configuration backup..."
	./scripts/manage-config.sh backup

config-restore: ## Restore configurations from backup (usage: make config-restore FILE=backup.tar.gz)
	@echo "Restoring configuration from $(FILE)..."
	./scripts/manage-config.sh restore $(FILE)

# =============================================================================
# BACKUP MANAGEMENT
# =============================================================================

backup-create: ## Create backup (usage: make backup-create TYPE=database NAME=mybackup)
	@echo "Creating $(TYPE) backup..."
	./scripts/manage-backups.sh create $(TYPE) $(NAME)

backup-restore: ## Restore from backup (usage: make backup-restore TYPE=database FILE=backup.sql)
	@echo "Restoring $(TYPE) from $(FILE)..."
	./scripts/manage-backups.sh restore $(TYPE) $(FILE)

backup-list: ## List backups (usage: make backup-list TYPE=database)
	@echo "Listing backups..."
	./scripts/manage-backups.sh list $(TYPE)

backup-status: ## Show backup status (usage: make backup-status JOB_ID=backup_123)
	@echo "Getting backup status..."
	./scripts/manage-backups.sh status $(JOB_ID)

backup-cleanup: ## Cleanup old backups
	@echo "Cleaning up old backups..."
	./scripts/manage-backups.sh cleanup

backup-full: ## Create full system backup
	@echo "Creating full system backup..."
	./scripts/manage-backups.sh full

backup-recovery: ## Disaster recovery (usage: make backup-recovery DIR=backups/)
	@echo "Starting disaster recovery..."
	./scripts/manage-backups.sh recovery $(DIR)

backup-verify: ## Verify backup integrity (usage: make backup-verify FILE=backup.tar.gz)
	@echo "Verifying backup integrity..."
	./scripts/manage-backups.sh verify $(FILE)

backup-stats: ## Show backup statistics
	@echo "Backup statistics:"
	./scripts/manage-backups.sh stats

backup-monitor: ## Run backup monitoring checks
	@echo "Running backup monitoring checks..."
	python scripts/backup-monitor.py monitor

backup-health: ## Check backup system health
	@echo "Checking backup system health..."
	python scripts/backup-monitor.py check-health

backup-storage: ## Check backup storage health
	@echo "Checking backup storage health..."
	python scripts/backup-monitor.py check-storage

backup-report: ## Generate backup health report
	@echo "Generating backup health report..."
	python scripts/backup-monitor.py report

# =============================================================================
# AWS DEPLOYMENT MANAGEMENT
# =============================================================================

aws-deploy-full: ## Deploy full application to AWS (infrastructure + app)
	@echo "Starting full AWS deployment..."
	./scripts/deploy-aws.sh full

aws-deploy-update: ## Update application on existing AWS infrastructure
	@echo "Updating application on AWS..."
	./scripts/deploy-aws.sh update

aws-deploy-plan: ## Plan AWS infrastructure changes
	@echo "Planning AWS infrastructure changes..."
	./scripts/deploy-aws.sh plan

aws-deploy-apply: ## Apply AWS infrastructure changes
	@echo "Applying AWS infrastructure changes..."
	./scripts/deploy-aws.sh apply

aws-deploy-build: ## Build and push Docker image to ECR
	@echo "Building and pushing Docker image..."
	./scripts/deploy-aws.sh build

aws-deploy-app: ## Deploy application to ECS
	@echo "Deploying application to ECS..."
	./scripts/deploy-aws.sh deploy

aws-destroy: ## Destroy AWS infrastructure (WARNING: deletes everything)
	@echo "WARNING: This will destroy all AWS infrastructure!"
	@echo "Make sure you have backups of important data."
	@read -p "Type 'destroy' to confirm: " confirm; \
	if [ "$$confirm" = "destroy" ]; then \
		./scripts/deploy-aws.sh destroy; \
	else \
		echo "Destruction cancelled."; \
	fi

aws-status: ## Check AWS deployment status
	@echo "Checking AWS deployment status..."
	./scripts/deploy-aws.sh status

aws-health: ## Run AWS health checks
	@echo "Running AWS health checks..."
	./scripts/deploy-aws.sh health

# =============================================================================
# AZURE DEPLOYMENT MANAGEMENT
# =============================================================================

azure-deploy-full: ## Deploy full application to Azure (infrastructure + app)
	@echo "Starting full Azure deployment..."
	./scripts/deploy-azure.sh full

azure-deploy-update: ## Update application on existing Azure infrastructure
	@echo "Updating application on Azure..."
	./scripts/deploy-azure.sh update

azure-deploy-plan: ## Plan Azure infrastructure changes
	@echo "Planning Azure infrastructure changes..."
	./scripts/deploy-azure.sh plan

azure-deploy-apply: ## Apply Azure infrastructure changes
	@echo "Applying Azure infrastructure changes..."
	./scripts/deploy-azure.sh apply

azure-deploy-build: ## Build and push Docker image to ACR
	@echo "Building and pushing Docker image..."
	./scripts/deploy-azure.sh build

azure-deploy-app: ## Deploy application to Azure Container Apps
	@echo "Deploying application to Azure Container Apps..."
	./scripts/deploy-azure.sh deploy

azure-destroy: ## Destroy Azure infrastructure (WARNING: deletes everything)
	@echo "WARNING: This will destroy all Azure infrastructure!"
	@echo "Make sure you have backups of important data."
	@read -p "Type 'destroy' to confirm: " confirm; \
	if [ "$$confirm" = "destroy" ]; then \
		./scripts/deploy-azure.sh destroy; \
	else \
		echo "Destruction cancelled."; \
	fi

azure-status: ## Check Azure deployment status
	@echo "Checking Azure deployment status..."
	./scripts/deploy-azure.sh status

azure-health: ## Run Azure health checks
	@echo "Running Azure health checks..."
	./scripts/deploy-azure.sh health