<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#238636">
    <meta name="description" content="Professional game server management and community platform">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Panel">
    <meta name="msapplication-TileColor" content="#238636">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="manifest" href="/static/manifest.json">
    <title>Panel</title>
    <!-- Browser Detection - Must run before page render -->
    <script src="{{ url_for('static', filename='js/browser-detect.js') }}"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function() {
        try {
          var root = document.documentElement;
          var toggleEnabled = {{ 'true' if theme_toggle_enabled else 'false' }};
          var forced = '{{ theme_forced or "" }}';
          if (!toggleEnabled && forced) {
            root.setAttribute('data-theme', forced);
          } else {
            var serverPref = '{{ "light" if (user_theme_pref == "light") else ("dark" if (user_theme_pref == "dark") else "") }}';
            var local = localStorage.getItem('theme');
            var theme = local || serverPref;
            if (!theme) {
              var prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
              theme = prefersLight ? 'light' : 'dark';
            }
            root.setAttribute('data-theme', theme);
          }
        } catch (e) {}
      })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    {% if theme_enabled %}
    <link rel="stylesheet" href="/theme.css" />
    {% endif %}
  </head>
  <body class="fade-in">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header>
      <div class="container">
        <nav>
          <div class="nav-brand">
            <a href="/" class="brand-link">
              <h3 style="margin: 0; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">⚡ Panel</h3>
            </a>
          </div>
          <div class="nav-links">
            <a href="/" class="{{ 'active' if request.endpoint == 'index' }}">🏠 Home</a>
            <a href="{{ url_for('forum.index') }}" class="{{ 'active' if request.endpoint and 'forum' in request.endpoint }}">💬 Forum</a>
            <a href="{{ url_for('cms.blog_index') }}" class="{{ 'active' if request.endpoint and 'blog' in request.endpoint }}">📰 Blog</a>
            {% if not logged_in %}
              <a href="/login" class="{{ 'active' if request.endpoint == 'login' }}">🔐 Login</a>
              <a href="/register" class="{{ 'active' if request.endpoint == 'register' }}">📝 Register</a>
            {% else %}
              <a href="/dashboard" class="{{ 'active' if request.endpoint == 'dashboard' }}">📊 Dashboard</a>
              <a href="/profile" class="{{ 'active' if request.endpoint == 'profile' }}">👤 Profile</a>
              <a href="/api/docs" class="{{ 'active' if request.endpoint == 'api_docs' }}">📚 API Docs</a>
              <a href="/api/tokens" class="{{ 'active' if request.endpoint == 'api_get_tokens' }}">🔑 API Tokens</a>
              {% if user.is_system_admin() %}
                <a href="/analytics" class="{{ 'active' if request.endpoint == 'analytics_dashboard' }}">📈 Analytics</a>
                <a href="/admin/monitoring/dashboard" class="{{ 'active' if request.endpoint and 'monitoring' in request.endpoint }}">📊 Monitoring</a>
                <a href="/admin/teams" class="{{ 'active' if request.endpoint == 'teams_dashboard' }}">👥 Teams</a>
                <a href="/admin/security" class="{{ 'active' if request.endpoint == 'security_dashboard' }}">🔒 Security</a>
                <a href="/backups" class="{{ 'active' if request.endpoint == 'backup_dashboard' }}">💾 Backups</a>
                <a href="/admin/rbac/roles" class="{{ 'active' if 'rbac' in request.endpoint }}">👥 RBAC</a>
              {% endif %}
              <a href="/logout">🚪 Logout</a>
            {% endif %}
            <div class="footer-links">
              <a href="{{ url_for('privacy') }}">📋 Privacy</a>
              {% if logged_in %}
              <a href="{{ url_for('gdpr_tools') }}">🛡️ GDPR Tools</a>
              {% endif %}
            </div>
            {% if theme_toggle_enabled %}
              <button id="theme-toggle" class="theme-toggle-btn" aria-pressed="false" aria-describedby="theme-status" title="Toggle theme">
                <span class="icon" aria-hidden="true">🌙</span>
                <span class="label">Dark</span>
              </button>
              <span id="theme-status" class="visually-hidden" aria-live="polite"></span>
            {% endif %}
          </div>
        </nav>
      </div>
    </header>

    <main>
      <div class="container slide-in">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="alerts-container">
              {% for category, msg in messages %}
                <div class="alert alert-{{ category }}">
                  {% if category == 'success' %}
                    <span>✅</span>
                  {% elif category == 'error' %}
                    <span>❌</span>
                  {% elif category == 'warning' %}
                    <span>⚠️</span>
                  {% else %}
                    <span>ℹ️</span>
                  {% endif %}
                  {{ msg }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <main id="main-content">
            {% block content %}{% endblock %}
        </main>
      </div>
    </main>

    <style>
      #confirm-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; }
      #confirm-modal .panel { background:#fff; max-width:640px; margin:6% auto; padding:20px; border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,0.2); }
      #confirm-modal .panel p { font-size:1rem; margin:0 0 1rem 0; }
      #confirm-modal .controls { text-align:right; }
      #confirm-modal button { margin-left:8px; padding:8px 12px; }
      #confirm-modal button.primary { background:#0078d4; color:white; border:none; border-radius:4px; }
    </style>

    <div id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-message" tabindex="-1">
      <div class="panel" role="document">
        <p id="confirm-message">Are you sure?</p>
        <div class="controls">
          <button id="confirm-cancel">Cancel</button>
          <button id="confirm-ok" class="primary">OK</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        var btn = document.getElementById('theme-toggle');
        var statusEl = document.getElementById('theme-status');
        function updateToggle(theme){
          if(!btn) return;
          var icon = btn.querySelector('.icon');
          var label = btn.querySelector('.label');
          var next = (theme === 'dark') ? 'light' : 'dark';
          var aria = 'Switch to ' + (next.charAt(0).toUpperCase() + next.slice(1)) + ' theme';
          if(theme === 'dark'){
            if(icon) icon.textContent = '🌙';
            if(label) label.textContent = 'Dark';
            btn.setAttribute('aria-pressed','true');
          }else{
            if(icon) icon.textContent = '☀️';
            if(label) label.textContent = 'Light';
            btn.setAttribute('aria-pressed','false');
          }
          btn.setAttribute('aria-label', aria);
          btn.setAttribute('title', aria);
          if(statusEl){ statusEl.textContent = 'Current theme: ' + (theme.charAt(0).toUpperCase()+theme.slice(1)) + '. ' + aria + '.'; }
        }
        if(btn){
          var curInit = document.documentElement.getAttribute('data-theme') || 'dark';
          updateToggle(curInit);
          btn.addEventListener('click', function(){
            var cur = document.documentElement.getAttribute('data-theme') || 'dark';
            var next = (cur === 'dark') ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            updateToggle(next);
            try{ localStorage.setItem('theme', next); }catch(e){}
            var loggedIn = {{ 'true' if logged_in else 'false' }};
            if(loggedIn){
              try{
                var fd = new FormData();
                fd.append('theme', next);
                fd.append('csrf_token', '{{ session.csrf_token }}');
                fetch('/api/theme_pref', { method:'POST', body: fd });
              }catch(e){}
            }
          });
        }

        var lastFocused = null;
        function findClosestForm(el){ while(el && el.tagName !== 'FORM') el = el.parentElement; return el; }
        function openModal(message, onOk){
          var modal = document.getElementById('confirm-modal');
          document.getElementById('confirm-message').textContent = message || 'Are you sure?';
          lastFocused = document.activeElement;
          modal.style.display = 'block';
          modal.focus();
          var ok = document.getElementById('confirm-ok');
          var cancel = document.getElementById('confirm-cancel');
          function cleanup(){ modal.style.display='none'; ok.removeEventListener('click', okHandler); cancel.removeEventListener('click', cancelHandler); document.removeEventListener('keydown', keyHandler); if(lastFocused) lastFocused.focus(); }
          function okHandler(){ cleanup(); if(typeof onOk === 'function') onOk(); }
          function cancelHandler(){ cleanup(); }
          function keyHandler(e){ if(e.key === 'Escape') cancelHandler(); if(e.key === 'Enter') okHandler(); }
          ok.addEventListener('click', okHandler);
          cancel.addEventListener('click', cancelHandler);
          document.addEventListener('keydown', keyHandler);
        }
        document.addEventListener('click', function(e){
          var t = e.target;
          if(t && t.matches && t.matches('.confirm-btn')){
            e.preventDefault();
            var form = findClosestForm(t);
            var msg = (form && form.dataset && form.dataset.confirmMessage) ? form.dataset.confirmMessage : 'Are you sure?';
            openModal(msg, function(){ if(form) form.submit(); });
          }
        });
      })();
    </script>

    <!-- Theme Toggle Button -->
    <button id="theme-toggle-btn" class="theme-toggle" title="Toggle theme">
      <i class="fas fa-moon"></i>
    </button>

    <script>
      // Theme toggle functionality
      const themeToggle = document.getElementById('theme-toggle-btn');
      const html = document.documentElement;

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'dark';
      html.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      themeToggle.addEventListener('click', function() {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });

      function updateThemeIcon(theme) {
        const icon = themeToggle.querySelector('i');
        if (theme === 'dark') {
          icon.className = 'fas fa-moon';
        } else {
          icon.className = 'fas fa-sun';
        }
      }
    </script>
    <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
  </body>
</html>
