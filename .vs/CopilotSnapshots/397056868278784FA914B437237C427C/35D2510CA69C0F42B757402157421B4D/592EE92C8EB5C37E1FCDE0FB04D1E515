# Makefile for Panel Development
# Comprehensive utility commands for development, testing, and deployment

.PHONY: help install install-dev install-prod clean lint format test test-cov test-unit test-integration test-e2e coverage docs build deploy dev-server prod-server db-init db-migrate db-seed db-reset db-backup db-restore redis-start redis-stop redis-restart logs logs-follow backup restore check-security check-deps update-deps docker-build docker-run docker-stop docker-clean setup-dev setup-prod setup-ci ci-lint ci-test ci-build ci-deploy

# Default target
help: ## Show this help message
	@echo "Panel Development Makefile"
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'

# =============================================================================
# INSTALLATION & SETUP
# =============================================================================

install: ## Install production dependencies
	pip install -r requirements/requirements.txt

install-dev: ## Install development dependencies
	pip install -r requirements/requirements-dev.txt

install-prod: ## Install production dependencies only
	pip install --no-dev -r requirements/requirements.txt

setup-dev: ## Complete development environment setup
	@echo "Setting up development environment..."
	python -m venv .venv
	source .venv/bin/activate && make install-dev
	cp config.py.example config.py || echo "No config.py.example found"
	make db-init
	make db-seed
	@echo "Development setup complete! Run 'make dev-server' to start."

setup-prod: ## Production environment setup
	@echo "Setting up production environment..."
	make install-prod
	make db-init
	make db-migrate
	@echo "Production setup complete!"

setup-ci: ## CI environment setup
	pip install -r requirements/requirements-dev.txt
	pre-commit install

# =============================================================================
# DEVELOPMENT SERVER
# =============================================================================

dev-server: ## Start development server with hot reload
	@echo "Starting enhanced development server..."
	python tools/scripts/dev_server.py

prod-server: ## Start production server
	@echo "Starting production server..."
	export FLASK_ENV=production && gunicorn --bind 0.0.0.0:8080 --workers 4 app:create_app

# =============================================================================
# DATABASE MANAGEMENT
# =============================================================================

db-init: ## Initialize database
	@echo "Initializing database..."
	export FLASK_ENV=development && python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.create_all()"

db-migrate: ## Run database migrations
	@echo "Running database migrations..."
	export FLASK_ENV=development && flask db upgrade

db-seed: ## Seed database with sample data
	@echo "Seeding database with sample data..."
	export FLASK_ENV=development && python tools/scripts/db_seed.py

db-reset: ## Reset database (WARNING: destroys all data)
	@echo "Resetting database..."
	@echo "This will destroy all data. Are you sure? [y/N] " && read ans && [ $${ans:-N} = y ]
	export FLASK_ENV=development && python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.drop_all(); db.create_all()"
	make db-seed

db-backup: ## Backup database
	@echo "Backing up database..."
	python scripts/backup_manager.py backup

db-restore: ## Restore database from backup
	@echo "Available backups:"
	python scripts/backup_manager.py list
	@echo "Enter backup filename to restore:" && read filename
	python scripts/backup_manager.py restore $$filename

# =============================================================================
# TESTING
# =============================================================================

test: ## Run all tests
	pytest

test-unit: ## Run unit tests only
	pytest tests/ -k "not integration and not e2e"

test-integration: ## Run integration tests
	pytest tests/ -k "integration"

test-e2e: ## Run end-to-end tests
	pytest tests/ -k "e2e"

test-cov: ## Run tests with coverage
	pytest --cov=src/panel --cov-report=html --cov-report=term

coverage: ## Generate and open coverage report
	pytest --cov=src/panel --cov-report=html
	open htmlcov/index.html || xdg-open htmlcov/index.html || echo "Coverage report generated in htmlcov/"

# =============================================================================
# CODE QUALITY
# =============================================================================

lint: ## Run all linting tools
	black --check .
	isort --check-only .
	flake8 .
	mypy src/panel/
	pylint src/panel/ || true

format: ## Format code with black and isort
	black .
	isort .

check-security: ## Run security checks
	bandit -r src/panel/
	safety check
	pip-audit

check-deps: ## Check for outdated dependencies
	pip list --outdated

update-deps: ## Update dependencies
	pip install --upgrade -r requirements/requirements.txt
	pip install --upgrade -r requirements/requirements-dev.txt

# =============================================================================
# DOCUMENTATION
# =============================================================================

docs: ## Build documentation
	mkdocs build

docs-serve: ## Serve documentation locally
	mkdocs serve

# =============================================================================
# DOCKER
# =============================================================================

docker-build: ## Build Docker image
	docker build -t panel:latest .

docker-run: ## Run Docker container
	docker run -p 8080:8080 --env-file .env panel:latest

docker-stop: ## Stop Docker containers
	docker stop $$(docker ps -q --filter ancestor=panel) || true

docker-clean: ## Clean Docker images and containers
	docker system prune -f
	docker image rm panel:latest || true

# =============================================================================
# INFRASTRUCTURE
# =============================================================================

redis-start: ## Start Redis server
	redis-server --daemonize yes

redis-stop: ## Stop Redis server
	redis-cli shutdown || true

redis-restart: ## Restart Redis server
	make redis-stop
	sleep 2
	make redis-start

# =============================================================================
# LOGGING & MONITORING
# =============================================================================

logs: ## Show application logs
	tail -f logs/panel.log

logs-follow: ## Follow application logs
	tail -f logs/panel.log

logs-errors: ## Show error logs only
	tail -f logs/panel_errors.log

# =============================================================================
# BACKUP & RECOVERY
# =============================================================================

backup: ## Create full system backup
	@echo "Creating full system backup..."
	make db-backup
	tar -czf backup_$$(date +%Y%m%d_%H%M%S).tar.gz instance/ logs/ static/uploads/ || true
	@echo "Backup complete!"

restore: ## Restore from system backup
	@echo "Available backups:"
	ls -la backup_*.tar.gz 2>/dev/null || echo "No backups found"
	@echo "Enter backup filename to restore:" && read filename
	@echo "This will overwrite existing files. Are you sure? [y/N] " && read ans && [ $${ans:-N} = y ]
	tar -xzf $$filename

# =============================================================================
# CI/CD
# =============================================================================

ci-lint: ## Run CI linting checks
	pre-commit run --all-files

ci-test: ## Run CI test suite
	pytest --cov=src/panel --cov-report=xml --junitxml=test-results.xml

ci-build: ## Run CI build process
	make docker-build
	make test-cov

ci-deploy: ## Deploy to production (CI)
	@echo "Deploying to production..."
	# Add your deployment commands here

# =============================================================================
# UTILITIES
# =============================================================================

clean: ## Clean up temporary files
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .coverage htmlcov/ .pytest_cache/ .mypy_cache/
	rm -f logs/*.log.*

shell: ## Start Flask shell
	export FLASK_ENV=development && flask shell

routes: ## List all Flask routes
	export FLASK_ENV=development && flask routes

config: ## Show current configuration
	export FLASK_ENV=development && python -c "from app import create_app; app = create_app(); print(app.config)"

health: ## Check application health
	curl -f http://localhost:8080/health || echo "Application not running"

metrics: ## Show application metrics
	curl -f http://localhost:8080/metrics || echo "Metrics endpoint not available"

# =============================================================================
# DEVELOPMENT HELPERS
# =============================================================================

new-migration: ## Create new database migration
	@echo "Enter migration message:" && read message
	export FLASK_ENV=development && flask db migrate -m "$$message"

run-worker: ## Start background worker
	export FLASK_ENV=development && python tools/scripts/run_worker.py

run-tests-watch: ## Run tests in watch mode
	ptw --runner "pytest tests/" || pytest-watch tests/

# =============================================================================
# INFORMATION
# =============================================================================

info: ## Show project information
	@echo "Panel Development Environment"
	@echo "============================="
	@echo "Python version: $$(python --version)"
	@echo "Pip version: $$(pip --version)"
	@echo "Flask version: $$(python -c 'import flask; print(flask.__version__)' 2>/dev/null || echo 'Not installed')"
	@echo "Database: SQLite (development)"
	@echo "Cache: Redis"
	@echo "Web server: Flask (dev) / Gunicorn (prod)"
	@echo ""
	@echo "Useful commands:"
	@echo "  make dev-server    - Start development server"
	@echo "  make test          - Run all tests"
	@echo "  make lint          - Check code quality"
	@echo "  make db-seed       - Seed database with sample data"

.PHONY: help