# Makefile for Panel Development
# Comprehensive utility commands for development, testing, and deployment

.PHONY: help install install-dev install-prod clean lint format test test-cov test-unit test-integration test-e2e coverage docs build deploy dev-server prod-server db-init db-migrate db-seed db-reset db-backup db-restore redis-start redis-stop redis-restart logs logs-follow backup restore check-security check-deps update-deps docker-build docker-run docker-stop docker-clean setup-dev setup-prod setup-ci ci-lint ci-test ci-build ci-deploy

# Default target
help: ## Show this help message
	@echo "Panel Development Makefile"
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'

# =============================================================================
# INSTALLATION & SETUP
# =============================================================================

install: ## Install production dependencies
	pip install -r requirements/requirements.txt

install-dev: ## Install development dependencies
	pip install -r requirements/requirements-dev.txt

install-prod: ## Install production dependencies only
	pip install --no-dev -r requirements/requirements.txt

setup-dev: ## Complete development environment setup
	@echo "Setting up development environment..."
	python -m venv .venv
	source .venv/bin/activate && make install-dev
	cp config.py.example config.py || echo "No config.py.example found"
	make db-init
	make db-seed
	@echo "Development setup complete! Run 'make dev-server' to start."

setup-prod: ## Production environment setup
	@echo "Setting up production environment..."
	make install-prod
	make db-init
	make db-migrate
	@echo "Production setup complete!"

setup-ci: ## CI environment setup
	pip install -r requirements/requirements-dev.txt
	pre-commit install

# =============================================================================
# DEVELOPMENT SERVER
# =============================================================================

dev-server: ## Start development server with hot reload
	@echo "Starting enhanced development server..."
	python tools/scripts/dev_server.py

prod-server: ## Start production server
	@echo "Starting production server..."
	export FLASK_ENV=production && gunicorn --bind 0.0.0.0:8080 --workers 4 app:create_app

# =============================================================================
# DATABASE MANAGEMENT
# =============================================================================

db-init: ## Initialize database
	@echo "Initializing database..."
	export FLASK_ENV=development && python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.create_all()"}

db-migrate: ## Run database migrations
	@echo "Running database migrations..."
	export FLASK_ENV=development && flask db upgrade

db-seed: ## Seed database with sample data
	@echo "Seeding database with sample data..."
	export FLASK_ENV=development && python tools/scripts/db_seed.py

db-reset: ## Reset database (WARNING: destroys all data)
	@echo "Resetting database..."
	@echo "This will destroy all data. Are you sure? [y/N] " && read ans && [ $${ans:-N} = y ]
	export FLASK_ENV=development && python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.drop_all(); db.create_all()"
	make db-seed

db-backup: ## Backup database
	@echo "Backing up database..."
	python tools/scripts/backup_manager.py backup

db-restore: ## Restore database from backup
	@echo "Available backups:"
	python tools/scripts/backup_manager.py list
	@echo "Enter backup filename to restore:" && read filename
	python tools/scripts/backup_manager.py restore $$filename

db-optimize: ## Optimize database with indexes
	@echo "Optimizing database..."
	export FLASK_ENV=development && python -c "from src.panel.db_optimization import create_database_indexes; create_database_indexes()"