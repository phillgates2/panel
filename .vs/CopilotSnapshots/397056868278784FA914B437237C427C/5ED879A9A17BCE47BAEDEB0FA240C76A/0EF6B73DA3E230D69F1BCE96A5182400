#!/bin/bash
# Panel Application Installer
# Comprehensive and interactive installation script
# Usage: curl -fsSL https://raw.githubusercontent.com/phillgates2/panel/main/install.sh | bash

set -e

# Configuration
REPO_URL="https://github.com/phillgates2/panel.git"
REPO_BRANCH="main"
INSTALL_DIR="${PANEL_INSTALL_DIR:-/opt/panel}"
CONFIG_DIR="${PANEL_CONFIG_DIR:-/etc/panel}"
DATA_DIR="${PANEL_DATA_DIR:-/var/lib/panel}"
LOG_DIR="${PANEL_LOG_DIR:-/var/log/panel}"
BACKUP_DIR="${PANEL_BACKUP_DIR:-/var/backups/panel}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_header() {
    echo -e "${PURPLE}================================${NC}"
    echo -e "${PURPLE}$1${NC}"
    echo -e "${PURPLE}================================${NC}"
}

# Check if running as root
check_root() {
    if [[ $EUID -eq 0 ]]; then
        log_warn "Running as root. This will install system-wide."
        read -p "Continue? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Installation cancelled."
            exit 0
        fi
    fi
}

# Detect operating system
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if command -v lsb_release >/dev/null 2>&1; then
            OS=$(lsb_release -si | tr '[:upper:]' '[:lower:]')
            VERSION=$(lsb_release -sr)
        elif [[ -f /etc/os-release ]]; then
            . /etc/os-release
            OS=$ID
            VERSION=$VERSION_ID
        else
            OS=$(uname -s)
            VERSION=$(uname -r)
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
        VERSION=$(sw_vers -productVersion)
    else
        OS="unknown"
        VERSION="unknown"
    fi

    log_info "Detected OS: $OS $VERSION"
}

# Check system requirements
check_requirements() {
    log_header "Checking System Requirements"

    # Check available memory
    if command -v free >/dev/null 2>&1; then
        MEM_GB=$(free -g | awk 'NR==2{printf "%.0f", $2}')
        if [[ $MEM_GB -lt 2 ]]; then
            log_error "Insufficient memory: ${MEM_GB}GB. Minimum 2GB required."
            exit 1
        fi
        log_success "Memory: ${MEM_GB}GB"
    fi

    # Check available disk space
    DISK_GB=$(df -BG "$PWD" | tail -1 | awk '{print $4}' | sed 's/G//')
    if [[ $DISK_GB -lt 5 ]]; then
        log_error "Insufficient disk space: ${DISK_GB}GB. Minimum 5GB required."
        exit 1
    fi
    log_success "Disk space: ${DISK_GB}GB available"

    # Check if required commands exist
    local required_commands=("curl" "git" "python3" "pip3")
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            log_error "Required command not found: $cmd"
            case $cmd in
                python3)
                    log_info "Please install Python 3.8+ from https://python.org"
                    ;;
                pip3)
                    log_info "pip3 should come with Python 3.8+"
                    ;;
                git)
                    log_info "Please install Git from https://git-scm.com"
                    ;;
                curl)
                    log_info "curl should be available on most systems"
                    ;;
            esac
            exit 1
        fi
    done
    log_success "All required commands found"

    # Check Python version
    PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
    if python3 -c 'import sys; exit(0 if sys.version_info >= (3, 8) else 1)'; then
        log_success "Python version: $PYTHON_VERSION"
    else
        log_error "Python 3.8+ required. Found: $PYTHON_VERSION"
        exit 1
    fi
}

# Interactive configuration
interactive_config() {
    log_header "Panel Configuration"

    echo -e "${CYAN}Let's configure your Panel installation:${NC}"
    echo

    # Installation directory
    read -p "Installation directory [$INSTALL_DIR]: " input
    INSTALL_DIR=${input:-$INSTALL_DIR}

    # Domain name
    read -p "Domain name (leave empty for localhost): " DOMAIN_NAME

    # Database choice
    echo
    echo "Database options:"
    echo "1) SQLite (simple, no setup required)"
    echo "2) PostgreSQL (recommended for production)"
    echo "3) MySQL/MariaDB"
    read -p "Choose database [1]: " -n 1 -r
    echo
    case $REPLY in
        1)
            DB_TYPE="sqlite"
            ;;
        2)
            DB_TYPE="postgresql"
            ;;
        3)
            DB_TYPE="mysql"
            ;;
        *)
            DB_TYPE="sqlite"
            ;;
    esac

    # Database configuration
    if [[ $DB_TYPE == "postgresql" ]]; then
        read -p "PostgreSQL host [localhost]: " DB_HOST
        DB_HOST=${DB_HOST:-localhost}
        read -p "PostgreSQL port [5432]: " DB_PORT
        DB_PORT=${DB_PORT:-5432}
        read -p "PostgreSQL database name [panel]: " DB_NAME
        DB_NAME=${DB_NAME:-panel}
        read -p "PostgreSQL username: " DB_USER
        read -s -p "PostgreSQL password: " DB_PASSWORD
        echo
    elif [[ $DB_TYPE == "mysql" ]]; then
        read -p "MySQL host [localhost]: " DB_HOST
        DB_HOST=${DB_HOST:-localhost}
        read -p "MySQL port [3306]: " DB_PORT
        DB_PORT=${DB_PORT:-3306}
        read -p "MySQL database name [panel]: " DB_NAME
        DB_NAME=${DB_NAME:-panel}
        read -p "MySQL username: " DB_USER
        read -s -p "MySQL password: " DB_PASSWORD
        echo
    fi

    # Redis configuration
    read -p "Use Redis for caching? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        USE_REDIS=true
        read -p "Redis host [localhost]: " REDIS_HOST
        REDIS_HOST=${REDIS_HOST:-localhost}
        read -p "Redis port [6379]: " REDIS_PORT
        REDIS_PORT=${REDIS_PORT:-6379}
        read -p "Redis database [0]: " REDIS_DB
        REDIS_DB=${REDIS_DB:-0}
    else
        USE_REDIS=false
    fi

    # AI features
    echo
    echo "AI Features:"
    read -p "Enable AI chat assistant? (y/N): " -n 1 -r
    echo
    ENABLE_AI_CHAT=$([[ $REPLY =~ ^[Yy]$ ]] && echo true || echo false)

    if [[ $ENABLE_AI_CHAT == true ]]; then
        echo "AI Provider options:"
        echo "1) Azure OpenAI (recommended)"
        echo "2) Google Vertex AI"
        echo "3) OpenAI API"
        read -p "Choose AI provider [1]: " -n 1 -r
        echo
        case $REPLY in
            1)
                AI_PROVIDER="azure"
                read -p "Azure OpenAI endpoint: " AZURE_OPENAI_ENDPOINT
                read -p "Azure OpenAI API key: " AZURE_OPENAI_API_KEY
                ;;
            2)
                AI_PROVIDER="google"
                read -p "Google Cloud Project ID: " GOOGLE_CLOUD_PROJECT
                ;;
            3)
                AI_PROVIDER="openai"
                read -p "OpenAI API key: " OPENAI_API_KEY
                ;;
            *)
                AI_PROVIDER="azure"
                ;;
        esac
    fi

    # Deployment type
    echo
    echo "Deployment options:"
    echo "1) Development (with debug mode)"
    echo "2) Production (optimized)"
    read -p "Choose deployment type [1]: " -n 1 -r
    echo
    case $REPLY in
        2)
            DEPLOYMENT_TYPE="production"
            ;;
        *)
            DEPLOYMENT_TYPE="development"
            ;;
    esac

    # SSL/HTTPS
    if [[ -n $DOMAIN_NAME ]]; then
        read -p "Enable SSL/HTTPS? (y/N): " -n 1 -r
        echo
        ENABLE_SSL=$([[ $REPLY =~ ^[Yy]$ ]] && echo true || echo false)
    else
        ENABLE_SSL=false
    fi

    log_success "Configuration completed"
}

# Install system dependencies
install_system_deps() {
    log_header "Installing System Dependencies"

    case $OS in
        ubuntu|debian)
            log_info "Installing for Ubuntu/Debian..."
            sudo apt-get update
            sudo apt-get install -y \
                build-essential \
                python3-dev \
                python3-pip \
                python3-venv \
                git \
                curl \
                nginx \
                supervisor \
                redis-server \
                postgresql \
                postgresql-contrib \
                libpq-dev \
                libjpeg-dev \
                libpng-dev \
                libfreetype6-dev \
                liblcms2-dev \
                libwebp-dev \
                zlib1g-dev
            ;;
        centos|rhel|fedora)
            log_info "Installing for CentOS/RHEL/Fedora..."
            sudo yum groupinstall -y "Development Tools"
            sudo yum install -y \
                python3-devel \
                git \
                curl \
                nginx \
                supervisor \
                redis \
                postgresql-server \
                postgresql-contrib \
                libpq-devel \
                libjpeg-devel \
                libpng-devel \
                freetype-devel \
                lcms2-devel \
                libwebp-devel \
                zlib-devel
            ;;
        macos)
            log_info "Installing for macOS..."
            if ! command -v brew >/dev/null 2>&1; then
                log_error "Homebrew not found. Please install from https://brew.sh"
                exit 1
            fi
            brew install \
                python3 \
                git \
                curl \
                nginx \
                redis \
                postgresql
            ;;
        *)
            log_warn "Unsupported OS. Please install dependencies manually."
            ;;
    esac

    log_success "System dependencies installed"
}

# Setup database
setup_database() {
    log_header "Setting up Database"

    case $DB_TYPE in
        postgresql)
            log_info "Setting up PostgreSQL..."

            # Create database and user
            sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';" 2>/dev/null || true
            sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;" 2>/dev/null || true
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;" 2>/dev/null || true

            log_success "PostgreSQL database created"
            ;;
        mysql)
            log_info "Setting up MySQL..."

            # Create database and user
            mysql -u root -p << EOF
CREATE DATABASE IF NOT EXISTS $DB_NAME;
CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';
FLUSH PRIVILEGES;
EOF

            log_success "MySQL database created"
            ;;
        sqlite)
            log_info "Using SQLite (no setup required)"
            ;;
    esac
}

# Clone and setup application
setup_application() {
    log_header "Setting up Panel Application"

    # Create directories
    sudo mkdir -p "$INSTALL_DIR" "$CONFIG_DIR" "$DATA_DIR" "$LOG_DIR" "$BACKUP_DIR"
    sudo chown -R $USER:$USER "$INSTALL_DIR" "$DATA_DIR" "$LOG_DIR" "$BACKUP_DIR"

    # Clone repository
    if [[ -d "$INSTALL_DIR/.git" ]]; then
        log_info "Updating existing installation..."
        cd "$INSTALL_DIR"
        git pull origin $REPO_BRANCH
    else
        log_info "Cloning Panel repository..."
        git clone -b $REPO_BRANCH $REPO_URL "$INSTALL_DIR"
        cd "$INSTALL_DIR"
    fi

    # Create virtual environment
    log_info "Creating Python virtual environment..."
    python3 -m venv venv
    source venv/bin/activate

    # Install Python dependencies
    log_info "Installing Python dependencies..."
    pip install --upgrade pip
    pip install -r requirements/requirements.txt

    # Install additional AI dependencies if enabled
    if [[ $ENABLE_AI_CHAT == true ]]; then
        log_info "Installing AI dependencies..."
        pip install openai google-cloud-aiplatform azure-cognitiveservices-speech opencv-python-headless
    fi

    log_success "Application setup completed"
}

# Configure application
configure_application() {
    log_header "Configuring Panel Application"

    cd "$INSTALL_DIR"

    # Copy configuration template
    cp config/config.py.example config/config.py

    # Update configuration
    cat > config/config.py << EOF
import os

# Panel Configuration - Generated by installer
SECRET_KEY = "$(openssl rand -hex 32)"

# Database configuration
EOF

    case $DB_TYPE in
        postgresql)
            cat >> config/config.py << EOF
SQLALCHEMY_DATABASE_URI = f"postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME"
EOF
            ;;
        mysql)
            cat >> config/config.py << EOF
SQLALCHEMY_DATABASE_URI = f"mysql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME"
EOF
            ;;
        sqlite)
            cat >> config/config.py << EOF
SQLALCHEMY_DATABASE_URI = "sqlite:///$DATA_DIR/panel.db"
EOF
            ;;
    esac

    # Redis configuration
    if [[ $USE_REDIS == true ]]; then
        cat >> config/config.py << EOF

# Redis configuration
REDIS_URL = f"redis://$REDIS_HOST:$REDIS_PORT/$REDIS_DB"
CACHE_TYPE = "redis"
CACHE_REDIS_URL = REDIS_URL
EOF
    fi

    # AI configuration
    if [[ $ENABLE_AI_CHAT == true ]]; then
        cat >> config/config.py << EOF

# AI Configuration
AI_ENABLED = True
AI_CHAT_ENABLED = True
EOF

        case $AI_PROVIDER in
            azure)
                cat >> config/config.py << EOF
AZURE_OPENAI_ENDPOINT = "$AZURE_OPENAI_ENDPOINT"
AZURE_OPENAI_API_KEY = "$AZURE_OPENAI_API_KEY"
EOF
                ;;
            google)
                cat >> config/config.py << EOF
GOOGLE_CLOUD_PROJECT = "$GOOGLE_CLOUD_PROJECT"
VERTEX_AI_ENABLED = True
EOF
                ;;
            openai)
                cat >> config/config.py << EOF
OPENAI_API_KEY = "$OPENAI_API_KEY"
EOF
                ;;
        esac
    fi

    # Environment-specific settings
    if [[ $DEPLOYMENT_TYPE == "production" ]]; then
        cat >> config/config.py << EOF

# Production settings
DEBUG = False
TESTING = False
SESSION_COOKIE_SECURE = True
EOF
    else
        cat >> config/config.py << EOF

# Development settings
DEBUG = True
TESTING = False
EOF
    fi

    # Domain and SSL
    if [[ -n $DOMAIN_NAME ]]; then
        cat >> config/config.py << EOF

# Domain configuration
SERVER_NAME = "$DOMAIN_NAME"
EOF

        if [[ $ENABLE_SSL == true ]]; then
            cat >> config/config.py << EOF
PREFERRED_URL_SCHEME = "https"
EOF
        fi
    fi

    log_success "Configuration completed"
}

# Setup web server
setup_web_server() {
    log_header "Setting up Web Server"

    if [[ $DEPLOYMENT_TYPE == "production" ]]; then
        # Setup Nginx
        cat > /tmp/panel-nginx.conf << EOF
server {
    listen 80;
    server_name ${DOMAIN_NAME:-localhost};

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /static {
        alias $INSTALL_DIR/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF

        sudo cp /tmp/panel-nginx.conf /etc/nginx/sites-available/panel
        sudo ln -sf /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/
        sudo rm -f /etc/nginx/sites-enabled/default
        sudo systemctl reload nginx

        # Setup Supervisor
        cat > /tmp/panel-supervisor.conf << EOF
[program:panel]
directory=$INSTALL_DIR
command=$INSTALL_DIR/venv/bin/python app.py
user=$USER
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=$LOG_DIR/panel.log
EOF

        sudo cp /tmp/panel-supervisor.conf /etc/supervisor/conf.d/panel.conf
        sudo supervisorctl reread
        sudo supervisorctl update

        log_success "Production web server configured"
    else
        log_info "Development mode - run manually with: cd $INSTALL_DIR && source venv/bin/activate && python app.py"
    fi
}

# Setup SSL certificate
setup_ssl() {
    if [[ $ENABLE_SSL == true && -n $DOMAIN_NAME ]]; then
        log_header "Setting up SSL Certificate"

        # Install certbot
        if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get install -y certbot python3-certbot-nginx
        elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y certbot python3-certbot-nginx
        fi

        # Get SSL certificate
        sudo certbot --nginx -d "$DOMAIN_NAME" --non-interactive --agree-tos --email "admin@$DOMAIN_NAME"

        log_success "SSL certificate installed"
    fi
}

# Initialize database
initialize_database() {
    log_header "Initializing Database"

    cd "$INSTALL_DIR"
    source venv/bin/activate

    # Initialize database
    flask db upgrade

    # Create admin user
    log_info "Creating admin user..."
    python -c "
from app import create_app, db
from src.panel.models import User

app = create_app()
with app.app_context():
    db.create_all()

    # Create admin user if it doesn't exist
    admin = User.query.filter_by(username='admin').first()
    if not admin:
        admin = User(
            username='admin',
            email='admin@$DOMAIN_NAME',
            first_name='Admin',
            last_name='User',
            is_admin=True
        )
        admin.set_password('admin123!')
        db.session.add(admin)
        db.session.commit()
        print('Admin user created: admin / admin123!')
    "

    log_success "Database initialized"
}

# Create startup script
create_startup_script() {
    log_header "Creating Startup Scripts"

    # Create systemd service for production
    if [[ $DEPLOYMENT_TYPE == "production" ]]; then
        cat > /tmp/panel.service << EOF
[Unit]
Description=Panel Application
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$INSTALL_DIR
ExecStart=$INSTALL_DIR/venv/bin/python app.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

        sudo cp /tmp/panel.service /etc/systemd/system/panel.service
        sudo systemctl daemon-reload
        sudo systemctl enable panel
        sudo systemctl start panel

        log_success "Systemd service created and started"
    fi

    # Create convenience scripts
    cat > "$INSTALL_DIR/start.sh" << EOF
#!/bin/bash
cd "$INSTALL_DIR"
source venv/bin/activate
python app.py
EOF

    cat > "$INSTALL_DIR/stop.sh" << EOF
#!/bin/bash
pkill -f "python app.py"
EOF

    cat > "$INSTALL_DIR/restart.sh" << EOF
#!/bin/bash
cd "$INSTALL_DIR"
./stop.sh
sleep 2
./start.sh
EOF

    chmod +x "$INSTALL_DIR"/*.sh

    log_success "Startup scripts created"
}

# Display completion message
show_completion() {
    log_header "Installation Completed Successfully!"

    echo -e "${GREEN}Panel has been installed at: $INSTALL_DIR${NC}"
    echo -e "${GREEN}Configuration: $CONFIG_DIR${NC}"
    echo -e "${GREEN}Data: $DATA_DIR${NC}"
    echo -e "${GREEN}Logs: $LOG_DIR${NC}"
    echo

    if [[ $DEPLOYMENT_TYPE == "production" ]]; then
        echo -e "${CYAN}Application is running at: ${ENABLE_SSL:+https://}http://${DOMAIN_NAME:-localhost}${NC}"
        echo -e "${CYAN}Admin login: admin / admin123!${NC}"
        echo
        echo -e "${YELLOW}Next steps:${NC}"
        echo "1. Change the admin password"
        echo "2. Configure your domain DNS"
        echo "3. Set up monitoring and backups"
        echo "4. Review security settings"
    else
        echo -e "${CYAN}To start development server:${NC}"
        echo "cd $INSTALL_DIR"
        echo "source venv/bin/activate"
        echo "python app.py"
        echo
        echo -e "${CYAN}Application will be available at: http://localhost:5000${NC}"
    fi

    echo
    echo -e "${PURPLE}Useful commands:${NC}"
    echo "cd $INSTALL_DIR && ./start.sh    # Start application"
    echo "cd $INSTALL_DIR && ./stop.sh     # Stop application"
    echo "cd $INSTALL_DIR && ./restart.sh  # Restart application"
    echo
    echo -e "${PURPLE}Documentation: https://github.com/phillgates2/panel${NC}"
    echo -e "${PURPLE}Support: https://github.com/phillgates2/panel/issues${NC}"
}

# Main installation function
main() {
    log_header "Panel Application Installer"

    # Pre-installation checks
    check_root
    detect_os
    check_requirements

    # Interactive configuration
    interactive_config

    # Installation steps
    install_system_deps
    setup_database
    setup_application
    configure_application
    setup_web_server
    setup_ssl
    initialize_database
    create_startup_script

    # Completion
    show_completion

    log_success "Installation completed! 🎉"
}

# Run main function
main "$@"