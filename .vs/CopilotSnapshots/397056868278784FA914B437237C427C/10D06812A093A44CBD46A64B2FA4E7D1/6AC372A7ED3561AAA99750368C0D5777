#!/bin/bash
# Development Environment Setup Script
# This script sets up a complete development environment for the Panel project

set -e

echo "?? Setting up Panel development environment..."

# Check if we're in the right directory
if [ ! -f "app.py" ]; then
    echo "? Error: Please run this script from the panel project root directory"
    exit 1
fi

# Check Python version
PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
echo "?? Python version: $PYTHON_VERSION"

# Create virtual environment if it doesn't exist
if [ ! -d ".venv" ]; then
    echo "?? Creating virtual environment..."
    python3 -m venv .venv
else
    echo "? Virtual environment already exists"
fi

# Activate virtual environment
echo "?? Activating virtual environment..."
source .venv/bin/activate

# Upgrade pip
echo "??  Upgrading pip..."
pip install --upgrade pip

# Install development dependencies
echo "?? Installing development dependencies..."
pip install -r requirements/requirements-dev.txt

# Copy configuration files if they don't exist
if [ ! -f "config.py" ]; then
    if [ -f "config.py.example" ]; then
        echo "?? Copying config.py.example to config.py..."
        cp config.py.example config.py
        echo "??  Please edit config.py with your local settings"
    else
        echo "??  No config.py.example found. Creating basic config.py..."
        cat > config.py << 'EOF'
import os

# Basic development configuration
SECRET_KEY = os.environ.get('PANEL_SECRET_KEY', 'dev-secret-key-change-in-production')
SQLALCHEMY_DATABASE_URI = os.environ.get('PANEL_SQLITE_URI', 'sqlite:///panel_dev.db')
REDIS_URL = os.environ.get('PANEL_REDIS_URL', 'redis://127.0.0.1:6379/0')
CACHE_TYPE = 'redis'
CACHE_REDIS_URL = REDIS_URL

# Development settings
DEBUG = True
TESTING = False

# Admin settings (for development)
ADMIN_USER = 'admin'
ADMIN_PASSWORD = 'admin'

# Forum settings
FORUM_PER_PAGE = 10
FORUM_REPLIES_PER_PAGE = 20

# CMS settings
CMS_PER_PAGE = 10

# Rate limiting
RATELIMIT_STORAGE_URL = REDIS_URL
RATELIMIT_DEFAULT = "200 per hour"

# Logging
LOG_LEVEL = 'INFO'
LOG_DIR = 'instance/logs'

# File uploads
UPLOAD_FOLDER = 'static/uploads'
MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB

# Security
SESSION_COOKIE_SECURE = False
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'

# Feature flags
THEME_ENABLED = True
CAPTCHA_ENABLED = False  # Disable for development

# External services (set to None to disable)
DISCORD_WEBHOOK_URL = None
SLACK_WEBHOOK_URL = None
EOF
        echo "? Created basic config.py"
    fi
fi

# Initialize database
echo "???  Initializing database..."
export FLASK_ENV=development
python -c "from app import db, create_app; app = create_app(); app.app_context().push(); db.create_all()" 2>/dev/null || echo "Database initialization may have failed - check config.py"

# Seed database with sample data
echo "?? Seeding database with sample data..."
python tools/scripts/db_seed.py 2>/dev/null || echo "Database seeding failed - run 'make db-seed' after fixing any issues"

# Install pre-commit hooks
echo "?? Installing pre-commit hooks..."
pre-commit install 2>/dev/null || echo "Pre-commit not installed - run 'pip install pre-commit' and 'pre-commit install'"

# Create necessary directories
echo "?? Creating necessary directories..."
mkdir -p instance/logs
mkdir -p static/uploads
mkdir -p logs

# Set permissions
chmod +x scripts/*.sh 2>/dev/null || true
chmod +x scripts/*.py 2>/dev/null || true

# Start Redis if available
echo "🔄 Starting Redis..."
if command -v redis-server > /dev/null 2>&1; then
    redis-server --daemonize yes --port 6379
    echo "✅ Redis started on port 6379"
else
    echo "⚠️  Redis not installed - install Redis for full functionality"
fi

echo ""
echo "?? Development environment setup complete!"
echo ""
echo "Next steps:"
echo "1. Edit config.py with your settings"
echo "2. Run 'make dev-server' to start the development server"
echo "3. Visit http://localhost:8080 to see the application"
echo "4. Run 'make test' to run the test suite"
echo ""
echo "Useful commands:"
echo "  make dev-server    - Start development server"
echo "  make test         - Run tests"
echo "  make lint         - Check code quality"
echo "  make db-seed      - Seed database with sample data"
echo "  make clean        - Clean up temporary files"
echo ""
echo "Happy coding! ??"