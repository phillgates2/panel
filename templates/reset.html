{% extends 'base.html' %}
{% block content %}
<h2>Reset Password</h2>
<div class="container">
<form method="post">
  <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
  <label>New password: <input name="password" type="password" required></label><br>
  {% if not config.TESTING %}
  <div id="captcha-expired" class="alert alert-warning hidden">
    Captcha expired â€” it has been refreshed. Please solve the new captcha.
  </div>
  <div>
    <img id="captcha-img" src="/captcha.png" alt="captcha" />
    <button type="button" id="refresh">Refresh</button>
    <button type="button" id="audio">Play audio</button>
  </div>
  <label>Captcha: <input name="captcha" required></label><br>
  {% endif %}
  <button type="submit">Set Password</button>
</form>
</div>
{% if not config.TESTING %}
<script>
(function(){
  const img = document.getElementById('captcha-img');
  const banner = document.getElementById('captcha-expired');
  const input = document.querySelector('input[name="captcha"]');
  const EXP_MS = 180000;
  let timer = null;

  function refreshCaptcha(){ img.src = '/captcha.png?_' + Date.now(); }
  function scheduleExpiry(){
    if (timer) clearTimeout(timer);
    timer = setTimeout(()=>{
      if (banner) banner.style.display = 'block';
      refreshCaptcha();
      if (input) input.value = '';
    }, EXP_MS);
  }
  img.addEventListener('load', ()=>{ if (banner) banner.style.display = 'none'; scheduleExpiry(); });
  document.getElementById('refresh').addEventListener('click', refreshCaptcha);
  document.getElementById('audio').addEventListener('click', ()=>{ const a = new Audio('/captcha_audio?_' + Date.now()); a.play(); });
  scheduleExpiry();
})();
</script>
{% endif %}
{% endblock %}
