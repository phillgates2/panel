{% extends 'base.html' %}
{% block content %}
<div class="moderation-page" role="main" aria-labelledby="moderation-title">
    <h1 id="moderation-title">??? Chat Moderation</h1>

    <div class="moderation-tabs">
        <button class="tab-btn active" onclick="showTab('pending')">Pending</button>
        <button class="tab-btn" onclick="showTab('flagged')">Flagged</button>
        <button class="tab-btn" onclick="showTab('all')">All Messages</button>
    </div>

    <div id="messages-container" class="messages-container">
        <!-- Messages will be loaded here -->
    </div>
</div>

<script>
let currentTab = 'pending';

document.addEventListener('DOMContentLoaded', function() {
    loadMessages(currentTab);
});

function showTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadMessages(tab);
}

function loadMessages(tab) {
    let url = '/api/admin/chat-messages?tab=' + tab;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('messages-container');
            container.innerHTML = data.messages.map(msg => `
                <div class="message-item ${msg.moderated ? 'moderated' : 'unmoderated'} ${msg.flagged ? 'flagged' : ''}">
                    <div class="message-header">
                        <strong>${msg.username}</strong> in <em>${msg.room}</em>
                        <small>${new Date(msg.timestamp).toLocaleString()}</small>
                    </div>
                    <div class="message-content">${msg.message}</div>
                    <div class="message-actions">
                        ${!msg.moderated ? '<button onclick="moderate(' + msg.id + ', \'approve\')">Approve</button>' : ''}
                        ${msg.moderated ? '<button onclick="moderate(' + msg.id + ', \'reject\')">Reject</button>' : ''}
                        <button onclick="moderate(${msg.id}, 'flag')">Flag</button>
                    </div>
                </div>
            `).join('');
        });
}

function moderate(messageId, action) {
    fetch(`/api/chat/moderate/${messageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action })
    })
    .then(() => loadMessages(currentTab));
}
</script>

<style>
.moderation-page {
    max-width: 1000px;
    margin: 0 auto;
}

.moderation-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.tab-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    cursor: pointer;
    border-radius: 4px;
}

.tab-btn.active {
    background: var(--primary-color);
    color: white;
}

.messages-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
}

.message-item.unmoderated {
    border-left: 4px solid var(--warning-color);
}

.message-item.flagged {
    border-left: 4px solid var(--danger-color);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.message-content {
    margin-bottom: 0.5rem;
    font-style: italic;
}

.message-actions {
    display: flex;
    gap: 0.5rem;
}

.message-actions button {
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.message-actions button:nth-child(1) { background: var(--success-color); color: white; }
.message-actions button:nth-child(2) { background: var(--danger-color); color: white; }
.message-actions button:nth-child(3) { background: var(--warning-color); color: black; }
</style>
{% endblock %}