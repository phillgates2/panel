<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#238636">
    <meta name="description" content="Professional game server management and community platform">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Panel">
    <meta name="msapplication-TileColor" content="#238636">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="manifest" href="/static/manifest.json">
    <title>Panel</title>
    <!-- Browser Detection - Must run before page render -->
    <script src="{{ url_for('static', filename='js/browser-detect.js') }}"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function() {
        try {
          var root = document.documentElement;
          var toggleEnabled = {{ 'true' if theme_toggle_enabled else 'false' }};
          var forced = '{{ theme_forced or "" }}';
          if (!toggleEnabled && forced) {
            root.setAttribute('data-theme', forced);
          } else {
            var serverPref = '{{ user_theme_pref if user_theme_pref in ["light", "dark"] else "" }}';
            var local = localStorage.getItem('theme');
            var theme = local || serverPref;
            if (!theme) {
              var prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
              theme = prefersLight ? 'light' : 'dark';
            }
            root.setAttribute('data-theme', theme);
          }
        } catch (e) {}
      })();
    </script>
    <link rel="stylesheet" href="{{ get_cdn_url('css/style.css') }}">
    <link rel="stylesheet" href="{{ get_cdn_url('css/dark-mode.css') }}">
    <link rel="icon" href="{{ get_cdn_url('favicon.ico') }}" type="image/x-icon">
    {% if theme_enabled %}
    <link rel="stylesheet" href="/theme.css" />
    {% endif %}
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_TRACKING_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'GA_TRACKING_ID');
    </script>
  </head>
  <body class="fade-in">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header role="banner">
      <div class="container">
        <nav aria-label="Main navigation">
          <div class="nav-brand">
            <a href="/" class="brand-link" aria-label="Panel home">
              <h3 style="margin: 0; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">‚ö° Panel</h3>
            </a>
          </div>
          <div class="nav-links">
            <form action="{{ url_for('main.search') }}" method="get" class="search-form" role="search">
              <input type="search" name="q" placeholder="Search..." aria-label="Search site">
              <button type="submit" aria-label="Submit search">üîç</button>
            </form>
            <a href="{{ url_for('main.index') }}" class="{{ 'active' if request.endpoint == 'main.index' }}">üè† Home</a>
            <!-- <a href="{{ url_for('forum.index') }}" class="{{ 'active' if request.endpoint and 'forum' in request.endpoint }}">üí¨ Forum</a> -->
            <!-- <a href="{{ url_for('cms.blog_index') }}" class="{{ 'active' if request.endpoint and 'blog' in request.endpoint }}">üì∞ Blog</a> -->
            {% if not logged_in %}
              <!-- <a href="{{ url_for('login') }}" class="{{ 'active' if request.endpoint == 'login' }}">üîê Login</a> -->
              <!-- <a href="{{ url_for('register') }}" class="{{ 'active' if request.endpoint == 'register' }}">üìù Register</a> -->
            {% else %}
              <!-- <a href="{{ url_for('dashboard') }}" class="{{ 'active' if request.endpoint == 'dashboard' }}">üìä Dashboard</a> -->
              <a href="{{ url_for('main.profile') }}" class="{{ 'active' if request.endpoint == 'main.profile' }}">üë§ Profile</a>
              <!-- <a href="{{ url_for('api_docs') }}" class="{{ 'active' if request.endpoint == 'api_docs' }}">üìö API Docs</a> -->
              <!-- <a href="{{ url_for('api_get_tokens') }}" class="{{ 'active' if request.endpoint == 'api_get_tokens' }}">üîë API Tokens</a> -->
              {% if user.is_system_admin() %}
                <!-- <a href="{{ url_for('analytics_dashboard') }}" class="{{ 'active' if request.endpoint == 'analytics_dashboard' }}>üìà Analytics</a> -->
                <!-- <a href="{{ url_for('monitoring_dashboard') }}" class="{{ 'active' if request.endpoint and 'monitoring' in request.endpoint }}">üìä Monitoring</a> -->
                <!-- <a href="{{ url_for('teams_dashboard') }}" class="{{ 'active' if request.endpoint == 'teams_dashboard' }}">üë• Teams</a> -->
                <!-- <a href="{{ url_for('security_dashboard') }}" class="{{ 'active' if request.endpoint == 'security_dashboard' }}">üîí Security</a> -->
                <!-- <a href="{{ url_for('backup_dashboard') }}" class="{{ 'active' if request.endpoint == 'backup_dashboard' }}">üíæ Backups</a> -->
                <!-- <a href="{{ url_for('rbac_roles') }}" class="{{ 'active' if 'rbac' in request.endpoint }}">üë• RBAC</a> -->
              {% endif %}
              <!-- <a href="{{ url_for('logout') }}">üö™ Logout</a> -->
            {% endif %}
            <div class="footer-links">
              <!-- <a href="{{ url_for('privacy') }}">üìã Privacy</a> -->
              {% if logged_in %}
              <!-- <a href="{{ url_for('gdpr_tools') }}">üõ°Ô∏è GDPR Tools</a> -->
              {% endif %}
            </div>
            {% if theme_toggle_enabled %}
              <button id="theme-toggle" class="theme-toggle-btn" aria-pressed="false" aria-describedby="theme-status" title="Toggle theme">
                <span class="icon" aria-hidden="true">üåô</span>
                <span class="label">Dark</span>
              </button>
              <span id="theme-status" class="visually-hidden" aria-live="polite"></span>
            {% endif %}
          </div>
        </nav>
      </div>
    </header>

    <main>
      <div class="container slide-in">
        {% if breadcrumbs %}
        <nav aria-label="breadcrumb" class="breadcrumb-nav">
          <ol class="breadcrumb">
            {% for crumb in breadcrumbs %}
            <li class="breadcrumb-item{% if loop.last %} active{% endif %}">
              {% if not loop.last %}
              <a href="{{ crumb.url }}">{{ crumb.name }}</a>
              {% else %}
              {{ crumb.name }}
              {% endif %}
            </li>
            {% endfor %}
          </ol>
        </nav>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="alerts-container">
              {% for category, msg in messages %}
                <div class="alert alert-{{ category }}">
                  {% if category == 'success' %}
                    <span>‚úÖ</span>
                  {% elif category == 'error' %}
                    <span>‚ùå</span>
                  {% elif category == 'warning' %}
                    <span>‚ö†Ô∏è</span>
                  {% else %}
                    <span>‚ÑπÔ∏è</span>
                  {% endif %}
                  {{ msg }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <div id="main-content">
            {% block content %}{% endblock %}
        </div>
      </div>
    </main>

    <style>
      #confirm-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; }
      #confirm-modal .panel { background:#fff; max-width:640px; margin:6% auto; padding:20px; border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,0.2); }
      #confirm-modal .panel p { font-size:1rem; margin:0 0 1rem 0; }
      #confirm-modal .controls { text-align:right; }
      #confirm-modal button { margin-left:8px; padding:8px 12px; }
      #confirm-modal button.primary { background:#0078d4; color:white; border:none; border-radius:4px; }
    </style>

    <div id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-message" tabindex="-1">
      <div class="panel" role="document">
        <p id="confirm-message">Are you sure?</p>
        <div class="controls">
          <button id="confirm-cancel">Cancel</button>
          <button id="confirm-ok" class="primary">OK</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        var btn = document.getElementById('theme-toggle');
        var statusEl = document.getElementById('theme-status');
        function updateToggle(theme){
          if(!btn) return;
          var icon = btn.querySelector('.icon');
          var label = btn.querySelector('.label');
          var next = (theme === 'dark') ? 'light' : 'dark';
          var aria = 'Switch to ' + (next.charAt(0).toUpperCase() + next.slice(1)) + ' theme';
          if(theme === 'dark'){
            if(icon) icon.textContent = 'üåô';
            if(label) label.textContent = 'Dark';
            btn.setAttribute('aria-pressed','true');
          }else{
            if(icon) icon.textContent = '‚òÄÔ∏è';
            if(label) label.textContent = 'Light';
            btn.setAttribute('aria-pressed','false');
          }
          btn.setAttribute('aria-label', aria);
          btn.setAttribute('title', aria);
          if(statusEl){ statusEl.textContent = 'Current theme: ' + (theme.charAt(0).toUpperCase()+theme.slice(1)) + '. ' + aria + '.'; }
        }
        if(btn){
          var curInit = document.documentElement.getAttribute('data-theme') || 'dark';
          updateToggle(curInit);
          btn.addEventListener('click', function(){
            var cur = document.documentElement.getAttribute('data-theme') || 'dark';
            var next = (cur === 'dark') ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            updateToggle(next);
            try{ localStorage.setItem('theme', next); }catch(e){}
            var loggedIn = {{ 'true' if logged_in else 'false' }};
            if(loggedIn){
              try{
                var fd = new FormData();
                fd.append('theme', next);
                fd.append('csrf_token', '{{ session.csrf_token }}');
                fetch('/api/theme_pref', { method:'POST', body: fd });
              }catch(e){}
            }
          });
        }

        var lastFocused = null;
        function findClosestForm(el){ while(el && el.tagName !== 'FORM') el = el.parentElement; return el; }
        function openModal(message, onOk){
          var modal = document.getElementById('confirm-modal');
          document.getElementById('confirm-message').textContent = message || 'Are you sure?';
          lastFocused = document.activeElement;
          modal.style.display = 'block';
          modal.focus();
          var ok = document.getElementById('confirm-ok');
          var cancel = document.getElementById('confirm-cancel');
          function cleanup(){ modal.style.display='none'; ok.removeEventListener('click', okHandler); cancel.removeEventListener('click', cancelHandler); document.removeEventListener('keydown', keyHandler); if(lastFocused) lastFocused.focus(); }
          function okHandler(){ cleanup(); if(typeof onOk === 'function') onOk(); }
          function cancelHandler(){ cleanup(); }
          function keyHandler(e){ if(e.key === 'Escape') cancelHandler(); if(e.key === 'Enter') okHandler(); }
          ok.addEventListener('click', okHandler);
          cancel.addEventListener('click', cancelHandler);
          document.addEventListener('keydown', keyHandler);
        }
        document.addEventListener('click', function(e){
          var t = e.target;
          if(t && t.matches && t.matches('.confirm-btn')){
            e.preventDefault();
            var form = findClosestForm(t);
            var msg = (form && form.dataset && form.dataset.confirmMessage) ? form.dataset.confirmMessage : 'Are you sure?';
            openModal(msg, function(){ if(form) form.submit(); });
          }
        });
      })();
    </script>

    <!-- Theme Toggle Button -->
    <button id="theme-toggle-btn" class="theme-toggle" title="Toggle theme">
      <i class="fas fa-moon"></i>
    </button>

    <script>
      // Theme toggle functionality
      const themeToggle = document.getElementById('theme-toggle-btn');
      const html = document.documentElement;

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'dark';
      html.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      themeToggle.addEventListener('click', function() {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });

      function updateThemeIcon(theme) {
        const icon = themeToggle.querySelector('i');
        if (theme === 'dark') {
          icon.className = 'fas fa-moon';
        } else {
          icon.className = 'fas fa-sun';
        }
      }
    </script>
    <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/onboarding.js') }}"></script>

<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/static/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);

        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available
                showUpdateNotification();
              }
            });
          }
        });
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// PWA Update Notification
function showUpdateNotification() {
  const notification = document.createElement('div');
  notification.className = 'pwa-update-notification';
  notification.innerHTML = `
    <div class="pwa-update-content">
      <span>üîÑ App update available!</span>
      <button onclick="updateApp()" class="btn btn-sm btn-primary">Update</button>
      <button onclick="dismissUpdate()" class="btn btn-sm btn-secondary">Later</button>
    </div>
  `;
  document.body.appendChild(notification);

  // Auto-hide after 10 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 10000);
}

function updateApp() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(registration => {
      registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      window.location.reload();
    });
  }
}

function dismissUpdate() {
  const notification = document.querySelector('.pwa-update-notification');
  if (notification) {
    notification.remove();
  }
}

// PWA Install Prompt
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent the mini-infobar from appearing on mobile
  e.preventDefault();
  // Stash the event so it can be triggered later
  deferredPrompt = e;

  // Show install button
  showInstallPrompt();
});

function showInstallPrompt() {
  if (!deferredPrompt) return;

  const prompt = document.createElement('div');
  prompt.className = 'pwa-install-prompt';
  prompt.innerHTML = `
    <div class="pwa-install-content">
      <span>üì± Install Panel as an app?</span>
      <button onclick="installApp()" class="btn btn-sm btn-success">Install</button>
      <button onclick="dismissInstall()" class="btn btn-sm btn-secondary">Not now</button>
    </div>
  `;
  document.body.appendChild(prompt);
}

function installApp() {
  if (!deferredPrompt) return;

  // Show the install prompt
  deferredPrompt.prompt();

  // Wait for the user to respond to the prompt
  deferredPrompt.userChoice.then((choiceResult) => {
    if (choiceResult.outcome === 'accepted') {
      console.log('User accepted the install prompt');
    } else {
      console.log('User dismissed the install prompt');
    }
    deferredPrompt = null;

    // Hide the prompt
    dismissInstall();
  });
}

function dismissInstall() {
  const prompt = document.querySelector('.pwa-install-prompt');
  if (prompt) {
    prompt.remove();
  }
}

// Network status monitoring
function updateNetworkStatus() {
  const statusIndicator = document.querySelector('.network-status');
  if (!statusIndicator) return;

  if (navigator.onLine) {
    statusIndicator.className = 'network-status online';
    statusIndicator.innerHTML = 'üü¢ Online';
  } else {
    statusIndicator.className = 'network-status offline';
    statusIndicator.innerHTML = 'üî¥ Offline';
  }
}

window.addEventListener('online', updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);

// Initial status
updateNetworkStatus();

// SocketIO Real-time Features
const socket = io();

// SocketIO event handlers
socket.on('connect', () => {
  console.log('Connected to server');

  // Authenticate user if logged in
  {% if user %}
  socket.emit('authenticate', { user_id: {{ user.id }} });
  {% endif %}
});

socket.on('disconnect', () => {
  console.log('Disconnected from server');
});

socket.on('connected', (data) => {
  console.log('Server connection confirmed:', data);
});

socket.on('authenticated', (data) => {
  console.log('Real-time authentication successful:', data);
});

socket.on('user_status_change', (data) => {
  console.log('User status change:', data);
  updateUserStatus(data);
});

socket.on('notification', (data) => {
  console.log('Received notification:', data);
  showNotification(data);
});

socket.on('forum_update', (data) => {
  console.log('Forum update:', data);
  handleForumUpdate(data);
});

socket.on('forum_activity', (data) => {
  console.log('Forum activity:', data);
  displayForumActivity(data);
});

socket.on('user_typing', (data) => {
  console.log('User typing:', data);
  showTypingIndicator(data);
});

socket.on('online_users_list', (data) => {
  console.log('Online users:', data);
  updateOnlineUsersList(data);
});

socket.on('server_status_update', (data) => {
  console.log('Server status update:', data);
  updateServerStatus(data);
});

socket.on('error', (data) => {
  console.error('Socket error:', data);
});

// Real-time feature functions
function updateUserStatus(data) {
  // Update user status indicators in UI
  const statusElements = document.querySelectorAll(`[data-user-id="${data.user_id}"]`);
  statusElements.forEach(el => {
    el.className = data.online ? 'status-online' : 'status-offline';
    el.title = data.online ? 'Online' : 'Offline';
  });
}

function showNotification(data) {
  // Show in-app notification
  const notification = document.createElement('div');
  notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
  notification.innerHTML = `
    <strong>${data.title}</strong><br>
    <small>${data.body}</small>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  if (data.url) {
    notification.style.cursor = 'pointer';
    notification.onclick = () => window.location.href = data.url;
  }

  document.body.appendChild(notification);

  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

function handleForumUpdate(data) {
  // Update forum thread with new content
  if (data.type === 'new_post' || data.type === 'new_reply') {
    // Refresh post count or add new post to UI
    const threadElement = document.querySelector(`[data-thread-id="${data.thread_id}"]`);
    if (threadElement) {
      // Add visual indicator of new content
      threadElement.classList.add('has-new-content');
      setTimeout(() => threadElement.classList.remove('has-new-content'), 5000);
    }
  }
}

function displayForumActivity(data) {
  // Show recent forum activity
  const activityContainer = document.getElementById('forum-activity');
  if (activityContainer && data.activity) {
    activityContainer.innerHTML = data.activity.map(activity => `
      <div class="activity-item">
        <strong>${activity.author}</strong>: ${activity.content}
        <small class="text-muted">${new Date(activity.timestamp).toLocaleString()}</small>
      </div>
    `).join('');
  }
}

function showTypingIndicator(data) {
  // Show typing indicators in chat/forum
  const typingContainer = document.getElementById('typing-indicators');
  if (typingContainer) {
    if (data.action === 'start') {
      const indicator = document.createElement('div');
      indicator.id = `typing-${data.user_id}`;
      indicator.className = 'typing-indicator';
      indicator.innerHTML = `${data.username} is typing...`;
      typingContainer.appendChild(indicator);
    } else {
      const indicator = document.getElementById(`typing-${data.user_id}`);
      if (indicator) {
        indicator.remove();
      }
    }
  }
}

function updateOnlineUsersList(data) {
  // Update online users display
  const onlineContainer = document.getElementById('online-users');
  if (onlineContainer) {
    onlineContainer.innerHTML = `
      <div class="online-count">${data.count} users online</div>
      ${data.users.map(user => `
        <div class="online-user" data-user-id="${user.id}">
          <img src="/static/avatars/${user.avatar || 'default.png'}" alt="${user.name}" class="avatar-small">
          <span>${user.name}</span>
        </div>
      `).join('')}
    `;
  }
}

function updateServerStatus(data) {
  // Update server status displays
  const serverElement = document.querySelector(`[data-server-id="${data.server_id}"]`);
  if (serverElement) {
    const status = data.status;
    serverElement.querySelector('.server-players').textContent = `${status.players}/${status.max_players}`;
    serverElement.querySelector('.server-map').textContent = status.map;
    serverElement.querySelector('.server-ping').textContent = `${status.ping}ms`;

    // Update status indicator
    const statusIndicator = serverElement.querySelector('.server-status');
    statusIndicator.className = `server-status status-${status.status}`;
    statusIndicator.title = `Server ${status.status}`;
  }
}

// Export socket for use in other scripts
window.socket = socket;
<footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h4>Panel</h4>
            <p>Professional game server management and community platform.</p>
          </div>
          <div class="footer-section">
            <h4>Quick Links</h4>
            <ul>
              <li><a href="{{ url_for('main.help_page') }}">Help</a></li>
              <!-- <li><a href="{{ url_for('privacy') }}">Privacy Policy</a></li> -->
              <li><a href="/api/docs">API Documentation</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Community</h4>
            <ul>
              <!-- <li><a href="{{ url_for('forum.index') }}">Forum</a></li> -->
              <!-- <li><a href="{{ url_for('cms.blog_index') }}">Blog</a></li> -->
              <li><a href="{{ url_for('main.status') }}">Status</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2024 Panel. All rights reserved. | Version {{ app.config.get('VERSION', '1.0') }}</p>
        </div>
      </div>
    </footer>
  </body>
</html>
