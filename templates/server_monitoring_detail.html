{% extends "base.html" %}

{% block title %}{{ server.name }} - Detailed Monitoring{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('monitoring.monitoring_dashboard') }}">Monitoring</a></li>
                    <li class="breadcrumb-item active">{{ server.name }}</li>
                </ol>
            </nav>
            <h2>
                <i class="fas fa-server"></i> {{ server.name }}
                <span class="badge {% if latest_metrics and latest_metrics.is_online %}bg-success{% else %}bg-danger{% endif %} ms-2">
                    {% if latest_metrics and latest_metrics.is_online %}Online{% else %}Offline{% endif %}
                </span>
            </h2>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" onclick="refreshData()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-clock"></i> Time Range
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="?hours=1">Last Hour</a></li>
                    <li><a class="dropdown-item" href="?hours=6">Last 6 Hours</a></li>
                    <li><a class="dropdown-item" href="?hours=24">Last 24 Hours</a></li>
                    <li><a class="dropdown-item" href="?hours=168">Last Week</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Server Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Server Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Host:</strong></td>
                                    <td>{{ server.host }}:{{ server.port }}</td>
                                </tr>
                                <tr>
                                    <td><strong>RCON Port:</strong></td>
                                    <td>{{ server.rcon_port or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Created:</strong></td>
                                    <td>{{ server.created_at.strftime('%Y-%m-%d %H:%M:%S') if server.created_at else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Owner:</strong></td>
                                    <td>{{ server.user.username if server.user else 'N/A' }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-lg-6">
                            {% if latest_metrics %}
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Current Map:</strong></td>
                                    <td>{{ latest_metrics.map_name or 'Unknown' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Game Mode:</strong></td>
                                    <td>{{ latest_metrics.game_mode or 'Unknown' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Players:</strong></td>
                                    <td>{{ latest_metrics.player_count or 0 }} / {{ latest_metrics.max_players or 0 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Check:</strong></td>
                                    <td>{{ latest_metrics.timestamp.strftime('%Y-%m-%d %H:%M:%S') if latest_metrics.timestamp else 'Never' }}</td>
                                </tr>
                            </table>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                No metrics available for this server
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Metrics Cards -->
    {% if latest_metrics %}
    <div class="row mb-4">
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="metric-icon">
                        <i class="fas fa-users text-primary fa-2x"></i>
                    </div>
                    <h4 class="mt-2">{{ latest_metrics.player_count or 0 }}</h4>
                    <p class="text-muted mb-0">Players Online</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="metric-icon">
                        <i class="fas fa-microchip {% if latest_metrics.cpu_usage and latest_metrics.cpu_usage > 80 %}text-danger{% elif latest_metrics.cpu_usage and latest_metrics.cpu_usage > 60 %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                    </div>
                    <h4 class="mt-2">{{ "%.1f"|format(latest_metrics.cpu_usage or 0) }}%</h4>
                    <p class="text-muted mb-0">CPU Usage</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="metric-icon">
                        <i class="fas fa-memory {% if latest_metrics.memory_percentage and latest_metrics.memory_percentage > 80 %}text-danger{% elif latest_metrics.memory_percentage and latest_metrics.memory_percentage > 60 %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                    </div>
                    <h4 class="mt-2">{{ "%.1f"|format(latest_metrics.memory_percentage or 0) }}%</h4>
                    <p class="text-muted mb-0">Memory</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="metric-icon">
                        <i class="fas fa-hdd {% if latest_metrics.disk_usage and latest_metrics.disk_usage > 80 %}text-danger{% elif latest_metrics.disk_usage and latest_metrics.disk_usage > 60 %}text-warning{% else %}text-success{% endif %} fa-2x"></i>
                    </div>
                    <h4 class="mt-2">{{ "%.1f"|format(latest_metrics.disk_usage or 0) }}%</h4>
                    <p class="text-muted mb-0">Disk Usage</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="metric-icon">
                        <i class="fas fa-network-wired text-info fa-2x"></i>
                    </div>
                    <h4 class="mt-2">{{ latest_metrics.network_in_mb|default(0, true)|round(1) }}</h4>
                    <p class="text-muted mb-0">Network In (MB)</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="metric-icon">
                        <i class="fas fa-stopwatch text-secondary fa-2x"></i>
                    </div>
                    <h4 class="mt-2">{{ latest_metrics.ping_ms or 0 }}</h4>
                    <p class="text-muted mb-0">Ping (ms)</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Performance Charts -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">CPU & Memory Usage</h6>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Player Count Over Time</h6>
                </div>
                <div class="card-body">
                    <canvas id="playerChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Network & Disk Usage -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card">
                <div class="header">
                    <h6 class="mb-0">Network Traffic</h6>
                </div>
                <div class="card-body">
                    <canvas id="networkChart" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Disk & Ping Metrics</h6>
                </div>
                <div class="card-body">
                    <canvas id="diskPingChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Player Sessions -->
    {% if player_sessions %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Active Player Sessions</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Connect Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in player_sessions %}
                                <tr>
                                    <td>{{ session.player_name }}</td>
                                    <td>{{ session.connect_time.strftime('%H:%M:%S') if session.connect_time else 'N/A' }}</td>
                                    <td>
                                        {% if session.connect_time %}
                                            {% set duration = moment().diff(session.connect_time) %}
                                            {{ duration.humanize() if duration else 'Unknown' }}
                                        {% else %}
                                            Unknown
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">Connected</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Server Alerts -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Recent Alerts</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadAlerts()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="alerts-container">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin"></i> Loading alerts...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.metric-icon {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-container {
    position: relative;
    height: 250px;
}

.alert-item {
    border-left: 4px solid;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 0.375rem;
}

.alert-critical {
    border-left-color: #dc3545;
    background-color: #f8d7da;
}

.alert-warning {
    border-left-color: #ffc107;
    background-color: #fff3cd;
}

.alert-info {
    border-left-color: #0dcaf0;
    background-color: #d1ecf1;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart instances
let performanceChart, playerChart, networkChart, diskPingChart;

// Chart configuration
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top'
        }
    },
    scales: {
        x: {
            type: 'time',
            time: {
                displayFormats: {
                    minute: 'HH:mm',
                    hour: 'HH:mm'
                }
            }
        },
        y: {
            beginAtZero: true
        }
    }
};

function initializeCharts() {
    // Performance Chart (CPU & Memory)
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU Usage (%)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Memory Usage (%)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                }
            }
        }
    });

    // Player Chart
    const playerCtx = document.getElementById('playerChart').getContext('2d');
    playerChart = new Chart(playerCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Active Players',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: {
                        display: true,
                        text: 'Player Count'
                    }
                }
            }
        }
    });

    // Network Chart
    const networkCtx = document.getElementById('networkChart').getContext('2d');
    networkChart = new Chart(networkCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Network In (MB)',
                    data: [],
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    tension: 0.4
                },
                {
                    label: 'Network Out (MB)',
                    data: [],
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    tension: 0.4
                }
            ]
        },
        options: {
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: {
                        display: true,
                        text: 'MB'
                    }
                }
            }
        }
    });

    // Disk & Ping Chart
    const diskPingCtx = document.getElementById('diskPingChart').getContext('2d');
    diskPingChart = new Chart(diskPingCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Disk Usage (%)',
                    data: [],
                    borderColor: 'rgb(255, 205, 86)',
                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Ping (ms)',
                    data: [],
                    borderColor: 'rgb(201, 203, 207)',
                    backgroundColor: 'rgba(201, 203, 207, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Disk Usage (%)'
                    },
                    max: 100
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Ping (ms)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// Load server metrics
function loadServerMetrics() {
    const serverId = {{ server.id }};
    const urlParams = new URLSearchParams(window.location.search);
    const hours = urlParams.get('hours') || 24;
    
    fetch(`/api/monitoring/server/${serverId}/metrics?hours=${hours}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCharts(data.metrics);
        } else {
            console.error('Error loading metrics:', data.message);
        }
    })
    .catch(error => {
        console.error('Error loading server metrics:', error);
    });
}

function updateCharts(metrics) {
    const labels = metrics.map(m => new Date(m.timestamp));
    
    // Performance Chart
    performanceChart.data.labels = labels;
    performanceChart.data.datasets[0].data = metrics.map(m => m.cpu_usage || 0);
    performanceChart.data.datasets[1].data = metrics.map(m => m.memory_percentage || 0);
    performanceChart.update('none');
    
    // Player Chart
    playerChart.data.labels = labels;
    playerChart.data.datasets[0].data = metrics.map(m => m.player_count || 0);
    playerChart.update('none');
    
    // Network Chart
    networkChart.data.labels = labels;
    networkChart.data.datasets[0].data = metrics.map(m => m.network_in_mb || 0);
    networkChart.data.datasets[1].data = metrics.map(m => m.network_out_mb || 0);
    networkChart.update('none');
    
    // Disk & Ping Chart
    diskPingChart.data.labels = labels;
    diskPingChart.data.datasets[0].data = metrics.map(m => m.disk_usage || 0);
    diskPingChart.data.datasets[1].data = metrics.map(m => m.ping_ms || 0);
    diskPingChart.update('none');
}

// Load server alerts
function loadAlerts() {
    const serverId = {{ server.id }};
    
    fetch(`/api/monitoring/server/${serverId}/alerts`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('alerts-container');
        
        if (data.success && data.alerts.length > 0) {
            let alertsHtml = '';
            
            data.alerts.forEach(alert => {
                const alertClass = alert.severity === 'critical' ? 'alert-critical' : 
                                 alert.severity === 'warning' ? 'alert-warning' : 'alert-info';
                
                alertsHtml += `
                    <div class="alert-item ${alertClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${alert.message}</strong>
                                <br>
                                <small class="text-muted">
                                    ${new Date(alert.triggered_at).toLocaleString()}
                                </small>
                            </div>
                            <span class="badge bg-${alert.severity === 'critical' ? 'danger' : alert.severity === 'warning' ? 'warning' : 'info'}">
                                ${alert.severity.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = alertsHtml;
        } else {
            container.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-check-circle text-success"></i>
                    <p class="mb-0">No recent alerts for this server</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading alerts:', error);
        document.getElementById('alerts-container').innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <p class="mb-0">Error loading alerts</p>
            </div>
        `;
    });
}

function refreshData() {
    loadServerMetrics();
    loadAlerts();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadServerMetrics();
    loadAlerts();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshData, 30000);
});
</script>
{% endblock %}