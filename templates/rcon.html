{% extends 'base.html' %}
{% block content %}
<h2>RCON Console</h2>
<div class="container">
{% if servers %}
<div class="mb-4">
  <label for="server-select" class="form-label">Select Server:</label>
  <select id="server-select" class="form-select" onchange="changeServer(this.value)">
    {% for server in servers %}
    <option value="{{ server.id }}" {% if current_server and current_server.id == server.id %}selected{% endif %}>
      {{ server.name }}{% if server.description %} - {{ server.description }}{% endif %}
    </option>
    {% endfor %}
  </select>
</div>

{% if current_server %}
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Console: {{ current_server.name }}</h5>
    <small class="text-muted">{{ current_server.host }}:{{ current_server.port }}</small>
    <div class="form-check form-switch float-end">
      <input class="form-check-input" type="checkbox" id="realtime-toggle" checked>
      <label class="form-check-label" for="realtime-toggle">
        Real-time updates
      </label>
    </div>
  </div>
  <div class="card-body">
    <form id="rcon-form" method="post">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
      <div class="input-group mb-3">
        <input type="text" id="command-input" class="form-control" placeholder="Enter RCON command..." required>
        <button type="submit" class="btn btn-primary" id="send-btn">Send Command</button>
      </div>
    </form>

    <div class="mt-3">
      <h6>Console Output:</h6>
      <div id="console-output" class="bg-dark text-light p-3 rounded console-output" style="font-family: 'Courier New', monospace; min-height: 300px; max-height: 500px; overflow-y: auto; white-space: pre-wrap;">
        <!-- Console output will appear here -->
      </div>
      <div class="mt-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearConsole()">Clear Console</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="scrollToBottom()">Scroll to Bottom</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Common Commands</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendQuickCommand('status')">status</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendQuickCommand('players')">players</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendQuickCommand('map_restart')">map_restart</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendQuickCommand('kick all')">kick all</button>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Quick Actions</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-info btn-sm" onclick="sendQuickCommand('g_gametype 2')">Set Campaign Mode</button>
          <button type="button" class="btn btn-outline-info btn-sm" onclick="sendQuickCommand('timelimit 20')">Set Time Limit 20min</button>
          <button type="button" class="btn btn-outline-warning btn-sm" onclick="sendQuickCommand('map oasis')">Change Map to Oasis</button>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="sendQuickCommand('quit')">Shutdown Server</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-warning">
  <h5>No Server Selected</h5>
  <p>Please select a server from the dropdown above to access its RCON console.</p>
</div>
{% endif %}
{% else %}
<div class="alert alert-info">
  <h5>No Servers Available</h5>
  <p>You don't have access to any servers. Contact an administrator to get server access.</p>
</div>
{% endif %}
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let socket;
let realtimeEnabled = true;
let currentServerId = {{ current_server.id if current_server else 'null' }};

function initSocketIO() {
    socket = io();

    socket.on('connect', function() {
        console.log('Connected to server');
        if (currentServerId && realtimeEnabled) {
            joinRconRoom();
        }
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });

    socket.on('joined_room', function(data) {
        addToConsole(`[SYSTEM] Joined RCON room for ${data.server_name}`, 'system');
    });

    socket.on('rcon_output', function(data) {
        const timestamp = new Date(data.timestamp).toLocaleTimeString();
        addToConsole(`[${timestamp}] ${data.user}: ${data.command}`, 'command');
        addToConsole(data.output, 'output');
    });

    socket.on('rcon_error', function(data) {
        addToConsole(`[ERROR] ${data.message}`, 'error');
    });
}

function joinRconRoom() {
    if (socket && currentServerId) {
        socket.emit('join_rcon', { server_id: currentServerId });
    }
}

function leaveRconRoom() {
    if (socket && currentServerId) {
        socket.emit('leave_rcon', { server_id: currentServerId });
    }
}

function sendCommand(command) {
    if (!command) return;

    if (realtimeEnabled && socket) {
        // Send via WebSocket
        socket.emit('rcon_command', {
            server_id: currentServerId,
            command: command
        });
    } else {
        // Fallback to HTTP POST
        const form = document.getElementById('rcon-form');
        const input = document.getElementById('command-input');
        input.value = command;
        form.submit();
    }
}

function addToConsole(text, type = 'output') {
    const output = document.getElementById('console-output');
    const line = document.createElement('div');
    line.className = `console-line console-${type}`;
    line.textContent = text;
    output.appendChild(line);
    scrollToBottom();
}

function clearConsole() {
    document.getElementById('console-output').innerHTML = '';
}

function scrollToBottom() {
    const output = document.getElementById('console-output');
    output.scrollTop = output.scrollHeight;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initSocketIO();

    // Form submission
    document.getElementById('rcon-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const command = document.getElementById('command-input').value.trim();
        if (command) {
            sendCommand(command);
            document.getElementById('command-input').value = '';
        }
    });

    // Real-time toggle
    document.getElementById('realtime-toggle').addEventListener('change', function(e) {
        realtimeEnabled = e.target.checked;
        if (realtimeEnabled) {
            joinRconRoom();
        } else {
            leaveRconRoom();
        }
    });

    // Enter key in command input
    document.getElementById('command-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('rcon-form').dispatchEvent(new Event('submit'));
        }
    });
});

function changeServer(serverId) {
    leaveRconRoom();
    window.location.href = '/rcon?server_id=' + serverId;
}

// Quick command buttons
function sendQuickCommand(command) {
    sendCommand(command);
}
</script>
{% endblock %}
