{% extends "base.html" %}

{% block title %}System Monitoring{% endblock %}

{% block content %}
<div class="container">
    <h1>System Dashboard</h1>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body" data-metric="cpu">
                    <h5 class="card-title">CPU Usage</h5>
                    <h2 class="metric-value">{{ "%.1f"|format(cpu_percent) }}%</h2>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar"
                             style="width: {{ cpu_percent }}%"
                             aria-valuenow="{{ cpu_percent }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body" data-metric="memory">
                    <h5 class="card-title">Memory Usage</h5>
                    <h2 class="metric-value">{{ "%.1f"|format(memory.percent) }}%</h2>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar"
                             style="width: {{ memory.percent }}%"
                             aria-valuenow="{{ memory.percent }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted metric-details">
                        {{ "%.1f"|format(memory.used / 1024 / 1024 / 1024) }} GB /
                        {{ "%.1f"|format(memory.total / 1024 / 1024 / 1024) }} GB
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body" data-metric="disk">
                    <h5 class="card-title">Disk Usage</h5>
                    <h2 class="metric-value">{{ "%.1f"|format(disk.percent) }}%</h2>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar"
                             style="width: {{ disk.percent }}%"
                             aria-valuenow="{{ disk.percent }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted metric-details">
                        {{ "%.1f"|format(disk.used / 1024 / 1024 / 1024) }} GB /
                        {{ "%.1f"|format(disk.total / 1024 / 1024 / 1024) }} GB
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Services</h5>
                    <p>
                        <strong>Gunicorn:</strong>
                        <span class="badge bg-{{ 'success' if gunicorn_status == 'active' else 'danger' }}">
                            {{ gunicorn_status }}
                        </span>
                    </p>
                    <p>
                        <strong>Worker:</strong>
                        <span class="badge bg-{{ 'success' if worker_status == 'active' else 'danger' }}">
                            {{ worker_status }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- System Alerts -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="systemAlerts"></div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Database Statistics</h5>
                    <table class="table table-sm">
                        <tr>
                            <th>Total Users:</th>
                            <td id="userCount">{{ user_count }}</td>
                        </tr>
                        <tr>
                            <th>Total Servers:</th>
                            <td id="serverCount">{{ server_count }}</td>
                        </tr>
                        <tr>
                            <th>Active Sessions:</th>
                            <td id="sessionCount">—</td>
                        </tr>
                        <tr>
                            <th>Running Processes:</th>
                            <td id="processCount">—</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Logins</h5>
                    <ul class="list-unstyled">
                        {% for activity in recent_logins %}
                        <li class="mb-2">
                            <small>
                                <strong>{{ activity.user.email if activity.user else 'Unknown' }}</strong>
                                from {{ activity.ip_address or 'Unknown IP' }}
                                <br>
                                <span class="text-muted">
                                    {{ activity.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </span>
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <span>
            <strong>Auto-refresh:</strong> Live metrics update every 30 seconds.
        </span>
        <div>
            <button id="refreshBtn" class="btn btn-outline-primary btn-sm me-2">
                <i class="fas fa-sync"></i> Refresh Now
            </button>
            <div class="form-check form-switch d-inline-block">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label" for="autoRefreshToggle">
                    Auto-refresh
                </label>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let autoRefreshEnabled = true;
    let refreshTimer;

    const refreshBtn = document.getElementById('refreshBtn');
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');

    // Manual refresh
    refreshBtn.addEventListener('click', function() {
        refreshMetrics();
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        this.disabled = true;
    });

    // Auto-refresh toggle
    autoRefreshToggle.addEventListener('change', function() {
        autoRefreshEnabled = this.checked;
        if (autoRefreshEnabled) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    function startAutoRefresh() {
        refreshTimer = setInterval(refreshMetrics, 30000); // 30 seconds
    }

    function stopAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
        }
    }

    function refreshMetrics() {
        fetch('/api/system/metrics')
            .then(response => response.json())
            .then(data => {
                updateMetrics(data);
                // Reset refresh button
                refreshBtn.innerHTML = '<i class="fas fa-sync"></i> Refresh Now';
                refreshBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error fetching metrics:', error);
                // Reset refresh button
                refreshBtn.innerHTML = '<i class="fas fa-sync"></i> Refresh Now';
                refreshBtn.disabled = false;
            });
    }

    function updateMetrics(data) {
        // Update CPU
        updateProgressBar('cpu', data.cpu);

        // Update Memory
        updateProgressBar('memory', data.memory.percent);
        updateMemoryDetails(data.memory);

        // Update Disk
        updateProgressBar('disk', data.disk.percent);
        updateDiskDetails(data.disk);

        // Update database stats
        updateDatabaseStats(data.database);

        // Update process count
        const processCount = document.getElementById('processCount');
        if (processCount && data.processes) {
            processCount.textContent = data.processes;
        }

        // Check for alerts
        checkAlerts(data);

        // Update timestamp
        const now = new Date().toLocaleTimeString();
        document.querySelectorAll('.metric-timestamp').forEach(el => {
            el.textContent = `Last updated: ${now}`;
        });
    }

    function updateProgressBar(type, percent) {
        const progressBar = document.querySelector(`[data-metric="${type}"] .progress-bar`);
        const percentText = document.querySelector(`[data-metric="${type}"] .metric-value`);

        if (progressBar) {
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
        }

        if (percentText) {
            percentText.textContent = percent.toFixed(1) + '%';
        }
    }

    function updateMemoryDetails(memory) {
        const details = document.querySelector('[data-metric="memory"] .metric-details');
        if (details) {
            const usedGB = (memory.used / 1024 / 1024 / 1024).toFixed(1);
            const totalGB = (memory.total / 1024 / 1024 / 1024).toFixed(1);
            details.textContent = `${usedGB} GB / ${totalGB} GB`;
        }
    }

    function updateDiskDetails(disk) {
        const details = document.querySelector('[data-metric="disk"] .metric-details');
        if (details) {
            const usedGB = (disk.used / 1024 / 1024 / 1024).toFixed(1);
            const totalGB = (disk.total / 1024 / 1024 / 1024).toFixed(1);
            details.textContent = `${usedGB} GB / ${totalGB} GB`;
        }
    }

    function updateDatabaseStats(database) {
        const userCount = document.getElementById('userCount');
        const serverCount = document.getElementById('serverCount');
        const sessionCount = document.getElementById('sessionCount');

        if (userCount && database.users !== undefined) {
            userCount.textContent = database.users;
        }
        if (serverCount && database.servers !== undefined) {
            serverCount.textContent = database.servers;
        }
        if (sessionCount && database.active_sessions !== undefined) {
            sessionCount.textContent = database.active_sessions;
        }
    }

    function checkAlerts(data) {
        const alerts = [];

        // CPU alert
        if (data.cpu > 80) {
            alerts.push({
                level: 'warning',
                message: `High CPU usage: ${data.cpu.toFixed(1)}%`
            });
        }

        // Memory alert
        if (data.memory.percent > 85) {
            alerts.push({
                level: 'warning',
                message: `High memory usage: ${data.memory.percent.toFixed(1)}%`
            });
        }

        // Disk alert
        if (data.disk.percent > 90) {
            alerts.push({
                level: 'danger',
                message: `Critical disk usage: ${data.disk.percent.toFixed(1)}%`
            });
        } else if (data.disk.percent > 80) {
            alerts.push({
                level: 'warning',
                message: `High disk usage: ${data.disk.percent.toFixed(1)}%`
            });
        }

        // Service alerts
        if (data.services && data.services.gunicorn !== 'active') {
            alerts.push({
                level: 'danger',
                message: 'Gunicorn service is not active'
            });
        }

        if (data.services && data.services.worker !== 'active') {
            alerts.push({
                level: 'warning',
                message: 'Worker service is not active'
            });
        }

        displayAlerts(alerts);
    }

    function displayAlerts(alerts) {
        const alertContainer = document.getElementById('systemAlerts');
        if (!alertContainer) return;

        if (alerts.length === 0) {
            alertContainer.innerHTML = '';
            return;
        }

        let html = '';
        alerts.forEach(alert => {
            html += `
                <div class="alert alert-${alert.level} alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>System Alert:</strong> ${alert.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        });

        alertContainer.innerHTML = html;
    }

    // Start auto-refresh
    startAutoRefresh();

    // Add timestamp elements to metrics
    document.querySelectorAll('.card-body').forEach(card => {
        if (!card.querySelector('.metric-timestamp')) {
            const timestamp = document.createElement('small');
            timestamp.className = 'text-muted metric-timestamp';
            timestamp.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            card.appendChild(timestamp);
        }
    });
});
</script>
{% endblock %}
