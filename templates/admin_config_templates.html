{% extends "base.html" %}

{% block title %}Configuration Templates{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Configuration Templates</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
            <i class="fas fa-plus"></i> Create Template
        </button>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Available Templates</h5>
                </div>
                <div class="card-body">
                    {% if templates %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Game Type</th>
                                    <th>Description</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for template in templates %}
                                <tr>
                                    <td>
                                        <strong>{{ template.name }}</strong>
                                        {% if template.is_default %}
                                        <span class="badge bg-primary">Default</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ template.game_type }}</td>
                                    <td>{{ template.description or 'No description' }}</td>
                                    <td>{{ template.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('config.edit_template', template_id=template.id) }}" 
                                               class="btn btn-outline-primary">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <button class="btn btn-outline-info" 
                                                    onclick="previewTemplate({{ template.id }})">
                                                <i class="fas fa-eye"></i> Preview
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="deleteTemplate({{ template.id }})">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                        <h5>No Configuration Templates</h5>
                        <p class="text-muted">Create your first configuration template to get started.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Configuration Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTemplateForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="templateName" class="form-label">Template Name</label>
                                <input type="text" class="form-control" id="templateName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gameType" class="form-label">Game Type</label>
                                <select class="form-control" id="gameType" required>
                                    <option value="etlegacy">ET:Legacy</option>
                                    <option value="quake3">Quake 3</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Configuration Files</h6>
                        <div class="accordion" id="configAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#serverCfgCollapse">
                                        Server Configuration (server.cfg)
                                    </button>
                                </h2>
                                <div id="serverCfgCollapse" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <textarea class="form-control font-monospace" id="serverCfg" 
                                                  rows="10" placeholder="Enter server.cfg content..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#campaignCfgCollapse">
                                        Campaign Configuration (campaign.cfg)
                                    </button>
                                </h2>
                                <div id="campaignCfgCollapse" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <textarea class="form-control font-monospace" id="campaignCfg" 
                                                  rows="8" placeholder="Enter campaign.cfg content..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#startupScriptCollapse">
                                        Startup Script (start_server.sh)
                                    </button>
                                </h2>
                                <div id="startupScriptCollapse" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <textarea class="form-control font-monospace" id="startupScript" 
                                                  rows="6" placeholder="Enter startup script content..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTemplate()">Create Template</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Template Modal -->
<div class="modal fade" id="previewTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templatePreviewContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function createTemplate() {
    const formData = {
        name: document.getElementById('templateName').value,
        description: document.getElementById('templateDescription').value,
        game_type: document.getElementById('gameType').value,
        template_data: {
            server_cfg: document.getElementById('serverCfg').value,
            campaign_cfg: document.getElementById('campaignCfg').value,
            startup_script: document.getElementById('startupScript').value
        }
    };
    
    fetch('{{ url_for("config.create_template") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the template');
    });
}

function previewTemplate(templateId) {
    fetch(`/api/config/templates/${templateId}/data`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let content = '<div class="accordion" id="previewAccordion">';
            
            Object.keys(data.template_data).forEach((key, index) => {
                const isFirst = index === 0;
                content += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#preview${index}">
                                ${key.replace(/_/g, ' ').toUpperCase()}
                            </button>
                        </h2>
                        <div id="preview${index}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}">
                            <div class="accordion-body">
                                <pre class="bg-light p-3 rounded">${data.template_data[key]}</pre>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += '</div>';
            document.getElementById('templatePreviewContent').innerHTML = content;
            
            const modal = new bootstrap.Modal(document.getElementById('previewTemplateModal'));
            modal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading template preview');
    });
}

function deleteTemplate(templateId) {
    if (confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
        fetch(`/admin/config/templates/${templateId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the template');
        });
    }
}
</script>
{% endblock %}